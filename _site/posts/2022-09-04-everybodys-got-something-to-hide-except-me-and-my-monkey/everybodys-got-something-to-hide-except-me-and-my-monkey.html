<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dan Simpson">
<meta name="dcterms.date" content="2022-09-06">
<meta name="description" content="A small introduction to multilevel models. Why? Because I said so, that’s why. And you will simply not believe what happens to residual plots.">

<title>Un garçon pas comme les autres (Bayes) - A first look at multilevel regression; or Everybody’s got something to hide except me and my macaques</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../site_libs/pagedtable-1.1/js/pagedtable.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Un garçon pas comme les autres (Bayes) - A first look at multilevel regression; or Everybody’s got something to hide except me and my macaques">
<meta property="og:description" content="A small introduction to multilevel models. Why? Because I said so, that’s why. And you will simply not believe what happens to residual plots.">
<meta property="og:image" content="https://dansblog.netlify.app/posts/2022-09-04-everybodys-got-something-to-hide-except-me-and-my-monkey/mark.png">
<meta property="og:site_name" content="Un garçon pas comme les autres (Bayes)">
<meta property="og:image:height" content="750">
<meta property="og:image:width" content="1334">
<meta name="twitter:title" content="A first look at multilevel regression; or Everybody’s got something to hide except me and my macaques">
<meta name="twitter:description" content="A small introduction to multilevel models. Why? Because I said so, that’s why. And you will simply not believe what happens to residual plots.">
<meta name="twitter:image" content="https://dansblog.netlify.app/posts/2022-09-04-everybodys-got-something-to-hide-except-me-and-my-monkey/mark.png">
<meta name="twitter:creator" content="@dan_p_simpson">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="750">
<meta name="twitter:image-width" content="1334">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Un garçon pas comme les autres (Bayes)</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About this blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/dan_p_simpson"> <i class="bi bi-twitter" role="img" aria-label="twitter">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dpsimpson"> <i class="bi bi-github" role="img" aria-label="github">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://dansblog.netlify.app"> <i class="bi bi-person-circle" role="img" aria-label="website">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">A first look at multilevel regression; or Everybody’s got something to hide except me and my macaques</h1>
                  <div>
        <div class="description">
          <p>A small introduction to multilevel models. Why? Because I said so, that’s why. And you will simply not believe what happens to residual plots.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Multilevel models</div>
                <div class="quarto-category">Visual diagnostics</div>
                <div class="quarto-category">Prior distributions</div>
                <div class="quarto-category">fundamentals</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://dansblog.netlify.app">Dan Simpson</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 6, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#what-are-the-stakes-according-to-the-papers-not-according-to-me-who-knows-exactly-nothing-about-this-type-of-work" id="toc-what-are-the-stakes-according-to-the-papers-not-according-to-me-who-knows-exactly-nothing-about-this-type-of-work" class="nav-link active" data-scroll-target="#what-are-the-stakes-according-to-the-papers-not-according-to-me-who-knows-exactly-nothing-about-this-type-of-work">What are the stake?s (According to the papers, not according to me, who knows exactly nothing about this type of work)</a></li>
  <li><a href="#so-what-did-eliza-and-mark-do" id="toc-so-what-did-eliza-and-mark-do" class="nav-link" data-scroll-target="#so-what-did-eliza-and-mark-do">So what did Eliza and Mark do?</a></li>
  <li><a href="#what-does-the-data-look-like" id="toc-what-does-the-data-look-like" class="nav-link" data-scroll-target="#what-does-the-data-look-like">What does the data look like?</a></li>
  <li><a href="#ok-mary-how-are-we-going-to-analyze-this-data" id="toc-ok-mary-how-are-we-going-to-analyze-this-data" class="nav-link" data-scroll-target="#ok-mary-how-are-we-going-to-analyze-this-data">Ok Mary, how are we going to analyze this data?</a>
  <ul class="collapse">
  <li><a href="#there-are-just-too-many-monkeys-or-why-cant-we-just-analyse-this-with-regression" id="toc-there-are-just-too-many-monkeys-or-why-cant-we-just-analyse-this-with-regression" class="nav-link" data-scroll-target="#there-are-just-too-many-monkeys-or-why-cant-we-just-analyse-this-with-regression">There are just too many monkeys; or Why can’t we just analyse this with regression?</a></li>
  <li><a href="#if-we-ignore-the-monkeys-will-they-go-away-or-another-attempt-at-regression" id="toc-if-we-ignore-the-monkeys-will-they-go-away-or-another-attempt-at-regression" class="nav-link" data-scroll-target="#if-we-ignore-the-monkeys-will-they-go-away-or-another-attempt-at-regression">If we ignore the monkeys, will they go away? or Another attempt at regression</a></li>
  </ul></li>
  <li><a href="#what-is-between-no-pooling-and-complete-pooling-multilevel-models-thats-what" id="toc-what-is-between-no-pooling-and-complete-pooling-multilevel-models-thats-what" class="nav-link" data-scroll-target="#what-is-between-no-pooling-and-complete-pooling-multilevel-models-thats-what">What is between no pooling and complete pooling? Multilevel models, that’s what</a></li>
  <li><a href="#reasoning-out-some-prior-distributions" id="toc-reasoning-out-some-prior-distributions" class="nav-link" data-scroll-target="#reasoning-out-some-prior-distributions">Reasoning out some prior distributions</a></li>
  <li><a href="#pre-experiment-prophylaxis" id="toc-pre-experiment-prophylaxis" class="nav-link" data-scroll-target="#pre-experiment-prophylaxis">Pre-experiment prophylaxis</a></li>
  <li><a href="#fitting-the-data-or-do-my-monkeys-get-less-interesting-as-they-age" id="toc-fitting-the-data-or-do-my-monkeys-get-less-interesting-as-they-age" class="nav-link" data-scroll-target="#fitting-the-data-or-do-my-monkeys-get-less-interesting-as-they-age">Fitting the data; or do my monkeys get less interesting as they age</a></li>
  <li><a href="#post-experiment-prophylaxis" id="toc-post-experiment-prophylaxis" class="nav-link" data-scroll-target="#post-experiment-prophylaxis">Post-experiment prophylaxis</a></li>
  <li><a href="#understanding-diagnostic-plots-from-multilevel-models" id="toc-understanding-diagnostic-plots-from-multilevel-models" class="nav-link" data-scroll-target="#understanding-diagnostic-plots-from-multilevel-models">Understanding diagnostic plots from multilevel models</a>
  <ul class="collapse">
  <li><a href="#making-new-data" id="toc-making-new-data" class="nav-link" data-scroll-target="#making-new-data">Making new data</a></li>
  <li><a href="#the-good-plots" id="toc-the-good-plots" class="nav-link" data-scroll-target="#the-good-plots">The good plots</a></li>
  <li><a href="#the-haunted-residual-vs-fitted-plot" id="toc-the-haunted-residual-vs-fitted-plot" class="nav-link" data-scroll-target="#the-haunted-residual-vs-fitted-plot">The haunted residual vs fitted plot</a></li>
  <li><a href="#so-what-the-hell-is-going-on" id="toc-so-what-the-hell-is-going-on" class="nav-link" data-scroll-target="#so-what-the-hell-is-going-on">So what the hell is going on?</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p><a href="https://www.elizablissmoreau.com">Eliza</a> knows a little something about monkeys. This will become relevant in a moment.</p>
<p>In about 2016, <a href="https://www.cell.com/current-biology/fulltext/S0960-9822(16)30460-2">Almeling <em>et al.</em></a> published a paper that suggested aged Barbary macaques maintained interest in members of their own species while losing interest in novel non-social stimuli (eg toys or puzzles with food inside).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="fx1.jpeg" class="img-fluid figure-img"></p>
<figcaption>I’d never come across the concept of a Graphical Abstract before, but here is the one for this paper. Graphic design is my passion. <a href="https://www.cell.com/current-biology/fulltext/S0960-9822(16)30460-2">Source</a></figcaption>
</figure>
</div>
<p>This is where Eliza—who knows a little something about monkeys—comes into frame: this did not gel with her experiences at all.</p>
<p>So Eliza (and <a href="https://scholar.google.com.au/citations?hl=en&amp;user=yg9U_okAAAAJ">Mark</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, who also knows a little something about monkeys) decided to look into it.</p>
<section id="what-are-the-stakes-according-to-the-papers-not-according-to-me-who-knows-exactly-nothing-about-this-type-of-work" class="level2">
<h2 class="anchored" data-anchor-id="what-are-the-stakes-according-to-the-papers-not-according-to-me-who-knows-exactly-nothing-about-this-type-of-work">What are the stake?s (According to the papers, not according to me, who knows exactly nothing<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> about this type of work)</h2>
<p>A big motivation for studying macaques and other non-human primates is that they’re good models of humans. This means that if there was solid evidence of macaques becoming less interested in novel stimuli as they age (while maintaining interest in people), this could suggest an evolutionary reason from this (commonly observed) behaviour in humans.</p>
<p>So if this result is true, it could help us understand the psychology of humans as they age (and in particular, the learned vs evolved trade off they are making).</p>
</section>
<section id="so-what-did-eliza-and-mark-do" class="level2">
<h2 class="anchored" data-anchor-id="so-what-did-eliza-and-mark-do">So what did Eliza and Mark do?</h2>
<p>There are a few things you can do when confronted with a result that contradicts your experience: you can complain about it on the Internet, you can mobilize a direct replication effort, or you can conduct your own experiments. Eliza and Mark opted for the third option, designing a <em>conceptual replication</em>.</p>
<p>Direct replications tell you more about the specific experiment that was conducted, but not necessarily more about the phenomenon under investigation. In a study involving aged monkeys<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>, it’s difficult to imagine how a direct replication could take place.</p>
<p>On the other hand, a conceptual replication has a lot more flexibility. It allows you to probe the question in a more targeted manner, appropriate for incremental science. In this case, Eliza and Mark opted to study only the claim that the monkeys lose interest in novel stimuli as they age (<a href="https://royalsocietypublishing.org/doi/full/10.1098/rsos.182237">paper here</a>). They did not look into the social claim. They also used a slightly different species of macaque (<em>M. mulatta</em> rather than <em>M. butterfly</em>). This is reasonable insofar as understanding macaques as a model for human behaviour.</p>
</section>
<section id="what-does-the-data-look-like" class="level2">
<h2 class="anchored" data-anchor-id="what-does-the-data-look-like">What does the data look like?</h2>
<p>The experiment used 243<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> monkeys aged between 4 and 30 and gave them a novel puzzle task (opening a fancy tube with food in it) for twenty minutes over two days. The puzzle was fitted with an activity tracker. Each monkey had two tries at the puzzle over two days. Monkeys had access to the puzzle for around<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> 20 minutes.</p>
<p>In order to match the original study’s analysis, Eliza and Mark divided the first two minutes into 15 second intervals and counted the number of intervals where the monkey interacted with the puzzle. They also measured the same thing over 20 minutes in order to see if there was a difference between short-term curiosity and more sustained exploration.</p>
<p>For each monkey, we have the following information:</p>
<ul>
<li>Monkey ID</li>
<li>Age (4-30)</li>
<li>Day (one or two)</li>
<li>Number of active intervals in the first two minutes (0-8)</li>
<li>Number of active intervals in the first twenty minutes (0-80)</li>
</ul>
<p>The data and their analysis are freely<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> available <a href="https://datadryad.org/stash/dataset/doi:10.5061/dryad.1bj133v">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a>acti_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"activity_data.csv"</span>) </span>
<span id="cb1-3"><a href="#cb1-3"></a>activity_2mins <span class="ot">&lt;-</span> acti_data <span class="sc">|&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="fu">filter</span>(obs<span class="sc">&lt;</span><span class="dv">9</span>) <span class="sc">|&gt;</span> <span class="fu">group_by</span>(subj_id, Day) <span class="sc">|&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="fu">summarize</span>(<span class="at">total=</span><span class="fu">sum</span>(Activity), </span>
<span id="cb1-6"><a href="#cb1-6"></a>            <span class="at">active_bins =</span> <span class="fu">sum</span>(Activity <span class="sc">&gt;</span> <span class="dv">0</span>), </span>
<span id="cb1-7"><a href="#cb1-7"></a>            <span class="at">age =</span> <span class="fu">min</span>(age)) <span class="sc">|&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="fu">rename</span>(<span class="at">monkey =</span> subj_id, <span class="at">day =</span> Day) <span class="sc">|&gt;</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a>activity_20minms80 <span class="ot">&lt;-</span> acti_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(obs<span class="sc">&lt;</span><span class="dv">81</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="fu">group_by</span>(subj_id, Day) <span class="sc">|&gt;</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="fu">summarize</span>(<span class="at">total=</span><span class="fu">sum</span>(Activity), </span>
<span id="cb1-14"><a href="#cb1-14"></a>            <span class="at">active_bins =</span> <span class="fu">sum</span>(Activity <span class="sc">&gt;</span> <span class="dv">0</span>), </span>
<span id="cb1-15"><a href="#cb1-15"></a>            <span class="at">age =</span> <span class="fu">min</span>(age)) <span class="sc">|&gt;</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>  <span class="fu">rename</span>(<span class="at">monkey =</span> subj_id, <span class="at">day =</span> Day) <span class="sc">|&gt;</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="fu">glimpse</span>(activity_20minms80)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 485
Columns: 5
$ monkey      &lt;dbl&gt; 0, 0, 88, 88, 636, 636, 760, 760, 1257, 1257, 1607, 1607, …
$ day         &lt;dbl&gt; 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2…
$ total       &lt;dbl&gt; 9881, 6356, 15833, 4988, 572, 308, 1097, 2916, 4884, 2366,…
$ active_bins &lt;int&gt; 42, 34, 43, 19, 10, 4, 12, 23, 50, 33, 9, 11, 13, 7, 30, 3…
$ age         &lt;dbl&gt; 29, 29, 29, 29, 28, 28, 30, 30, 27, 27, 27, 27, 27, 27, 26…</code></pre>
</div>
</div>
</section>
<section id="ok-mary-how-are-we-going-to-analyze-this-data" class="level2">
<h2 class="anchored" data-anchor-id="ok-mary-how-are-we-going-to-analyze-this-data">Ok Mary, how are we going to analyze this data?</h2>
<p>Eliza and Mark’s monkey data is an example of a fairly common type of experimental data, where the same subject is measured multiple times. It is useful to break the covariates down into three types: <em>grouping variables</em>, <em>group-level covariates</em>, and <em>individual-level covariates</em>.</p>
<p><em>Grouping variables</em> indicate what <em>group</em> each observation is in. We will see a lot of different ways of defining groups as we go on, but a core idea is that observations within a group should conceptually more similar to each other than observations in different groups. For Eliza and Mark, their grouping variable is <code>monkey</code>. This encodes the idea that different monkeys might have very different levels of curiosity, but the same monkey across two different days would probably have fairly similar levels of curiosity.</p>
<p><em>Group-level covariates</em> are covariates that describe a feature of the <em>group</em> rather than the observation. In this example, <code>age</code> is a group-level covariate, because the monkeys are the same age at each observation.</p>
<p><em>Individual-level covariates</em> are covariates that describe a feature that is specific to an observation. (The nomenclature here can be a bit confusing: the “individual” refers to individual observations, not to individual monkeys. All good naming conventions go to shit eventually.) The individual-level covariate is experiment day. This can be a bit harder to see than the other designations, but it’s a little clearer if you think of it as an indicator of whether this is the first time the monkey has seen the task or the second time. Viewed this way, it is very clearly a measurement of an property of an observation rather than of a group.</p>
<p>Eliza and Mark’s monkey data is an example of a fairly general type of experimental data where subjects (our groups) are given the same task under different experimental conditions (described through individual-level covariates). As we will see, it’s not uncommon to have much more complex group definitions (that involve several grouping covariates) and larger sets of both group-level and individual-level covariates.</p>
<p>So how do we fit a model to this data.</p>
<section id="there-are-just-too-many-monkeys-or-why-cant-we-just-analyse-this-with-regression" class="level3">
<h3 class="anchored" data-anchor-id="there-are-just-too-many-monkeys-or-why-cant-we-just-analyse-this-with-regression">There are just too many monkeys; or Why can’t we just analyse this with regression?</h3>
<p>The temptation with this sort of data is to fit a linear regression to it as a first model. In this case, we are using grouping, group-level, and individual-level covariates in the same way. Let’s suck it and see.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb3-2"><a href="#cb3-2"></a>fit_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(active_bins <span class="sc">~</span> age<span class="sc">*</span><span class="fu">factor</span>(day) <span class="sc">+</span> <span class="fu">factor</span>(monkey), <span class="at">data =</span> activity_2mins)</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="fu">tidy</span>(fit_lm) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["term"],"name":[1],"type":["chr"],"align":["left"]},{"label":["estimate"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["std.error"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["statistic"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["p.value"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"(Intercept)","2":"-6.688440e+00","3":"5.38400465","4":"-1.242280e+00","5":"0.215345864"},{"1":"age","2":"4.234598e-01","3":"0.21287645","4":"1.989228e+00","5":"0.047811367"},{"1":"factor(day)2","2":"1.879672e-03","3":"0.39658478","4":"4.739646e-03","5":"0.996222261"},{"1":"factor(monkey)88","2":"1.000000e+00","3":"1.70008898","4":"5.882045e-01","5":"0.556948129"},{"1":"factor(monkey)636","2":"-3.062500e+00","3":"1.60442379","4":"-1.908785e+00","5":"0.057482707"},{"1":"factor(monkey)760","2":"-2.937500e+00","3":"1.81569582","4":"-1.617837e+00","5":"0.107011195"},{"1":"factor(monkey)1257","2":"3.750000e-01","3":"1.53243949","4":"2.447079e-01","5":"0.806891726"},{"1":"factor(monkey)1607","2":"3.750000e-01","3":"1.53243949","4":"2.447079e-01","5":"0.806891726"},{"1":"factor(monkey)1632","2":"-2.125000e+00","3":"1.53243949","4":"-1.386678e+00","5":"0.166826659"},{"1":"factor(monkey)1860","2":"8.125000e-01","3":"1.48757785","4":"5.461899e-01","5":"0.585442774"},{"1":"factor(monkey)1869","2":"2.812500e+00","3":"1.48757785","4":"1.890657e+00","5":"0.059874728"},{"1":"factor(monkey)2191","2":"1.312500e+00","3":"1.48757785","4":"8.823068e-01","5":"0.378493776"},{"1":"factor(monkey)2637","2":"-2.500000e-01","3":"1.47232024","4":"-1.698000e-01","5":"0.865310455"},{"1":"factor(monkey)2747","2":"3.750000e+00","3":"1.47232024","4":"2.547000e+00","5":"0.011490788"},{"1":"factor(monkey)2833","2":"2.500000e-01","3":"1.47232024","4":"1.698000e-01","5":"0.865310455"},{"1":"factor(monkey)2912","2":"2.250000e+00","3":"1.47232024","4":"1.528200e+00","5":"0.127779712"},{"1":"factor(monkey)3536","2":"-3.125000e-01","3":"1.48757785","4":"-2.100730e-01","5":"0.833788896"},{"1":"factor(monkey)3545","2":"-8.125000e-01","3":"1.48757785","4":"-5.461899e-01","5":"0.585442774"},{"1":"factor(monkey)3696","2":"-3.812500e+00","3":"1.48757785","4":"-2.562891e+00","5":"0.010991577"},{"1":"factor(monkey)4009","2":"1.125000e+00","3":"1.53243949","4":"7.341236e-01","5":"0.463590006"},{"1":"factor(monkey)4392","2":"1.250000e-01","3":"1.53243949","4":"8.156929e-02","5":"0.935057207"},{"1":"factor(monkey)4624","2":"-4.375000e-01","3":"1.60442379","4":"-2.726836e-01","5":"0.785330940"},{"1":"factor(monkey)4686","2":"1.062500e+00","3":"1.60442379","4":"6.622315e-01","5":"0.508458252"},{"1":"factor(monkey)4776","2":"3.562500e+00","3":"1.60442379","4":"2.220423e+00","5":"0.027324613"},{"1":"factor(monkey)4795","2":"1.562500e+00","3":"1.60442379","4":"9.738699e-01","5":"0.331101681"},{"1":"factor(monkey)4886","2":"5.625000e-01","3":"1.60442379","4":"3.505932e-01","5":"0.726201115"},{"1":"factor(monkey)4964","2":"3.062500e+00","3":"1.60442379","4":"1.908785e+00","5":"0.057482707"},{"1":"factor(monkey)5252","2":"4.500000e+00","3":"1.70008898","4":"2.646920e+00","5":"0.008660496"},{"1":"factor(monkey)5332","2":"-5.000000e-01","3":"1.70008898","4":"-2.941023e-01","5":"0.768933965"},{"1":"factor(monkey)5388","2":"3.000000e+00","3":"1.70008898","4":"1.764614e+00","5":"0.078900697"},{"1":"factor(monkey)5413","2":"5.500000e+00","3":"1.70008898","4":"3.235125e+00","5":"0.001386994"},{"1":"factor(monkey)5453","2":"2.000000e+00","3":"1.70008898","4":"1.176409e+00","5":"0.240596983"},{"1":"factor(monkey)5498","2":"-5.000000e-01","3":"1.70008898","4":"-2.941023e-01","5":"0.768933965"},{"1":"factor(monkey)5604","2":"-2.680485e-14","3":"1.70008898","4":"-1.576674e-14","5":"1.000000000"},{"1":"factor(monkey)5607","2":"5.000000e-01","3":"1.70008898","4":"2.941023e-01","5":"0.768933965"},{"1":"factor(monkey)5646","2":"-1.747008e-14","3":"1.70008898","4":"-1.027598e-14","5":"1.000000000"},{"1":"factor(monkey)5774","2":"2.000000e+00","3":"1.70008898","4":"1.176409e+00","5":"0.240596983"},{"1":"factor(monkey)5895","2":"2.937500e+00","3":"1.81569582","4":"1.617837e+00","5":"0.107011195"},{"1":"factor(monkey)5967","2":"-6.250000e-02","3":"1.81569582","4":"-3.442207e-02","5":"0.972569200"},{"1":"factor(monkey)5990","2":"1.937500e+00","3":"1.81569582","4":"1.067084e+00","5":"0.287006110"},{"1":"factor(monkey)6008","2":"-6.250000e-02","3":"1.81569582","4":"-3.442207e-02","5":"0.972569200"},{"1":"factor(monkey)6098","2":"1.937500e+00","3":"1.81569582","4":"1.067084e+00","5":"0.287006110"},{"1":"factor(monkey)6159","2":"3.437500e+00","3":"1.81569582","4":"1.893214e+00","5":"0.059532471"},{"1":"factor(monkey)6258","2":"2.937500e+00","3":"1.81569582","4":"1.617837e+00","5":"0.107011195"},{"1":"factor(monkey)6264","2":"2.937500e+00","3":"1.81569582","4":"1.617837e+00","5":"0.107011195"},{"1":"factor(monkey)6287","2":"4.375000e-01","3":"1.81569582","4":"2.409545e-01","5":"0.809796132"},{"1":"factor(monkey)6505","2":"2.375000e+00","3":"1.94769661","4":"1.219389e+00","5":"0.223893579"},{"1":"factor(monkey)6512","2":"3.875000e+00","3":"1.94769661","4":"1.989530e+00","5":"0.047777867"},{"1":"factor(monkey)6516","2":"3.375000e+00","3":"1.94769661","4":"1.732816e+00","5":"0.084412906"},{"1":"factor(monkey)6807","2":"2.375000e+00","3":"1.94769661","4":"1.219389e+00","5":"0.223893579"},{"1":"factor(monkey)6877","2":"1.375000e+00","3":"1.94769661","4":"7.059621e-01","5":"0.480896409"},{"1":"factor(monkey)6930","2":"8.750000e-01","3":"1.94769661","4":"4.492486e-01","5":"0.653657739"},{"1":"factor(monkey)7261","2":"8.125000e-01","3":"2.09299182","4":"3.882003e-01","5":"0.698211947"},{"1":"factor(monkey)7289","2":"5.812500e+00","3":"2.09299182","4":"2.777125e+00","5":"0.005917223"},{"1":"factor(monkey)7307","2":"5.312500e+00","3":"2.09299182","4":"2.538233e+00","5":"0.011774807"},{"1":"factor(monkey)7321","2":"3.312500e+00","3":"2.09299182","4":"1.582663e+00","5":"0.114815239"},{"1":"factor(monkey)7333","2":"4.312500e+00","3":"2.09299182","4":"2.060448e+00","5":"0.040433840"},{"1":"factor(monkey)7451","2":"2.312500e+00","3":"2.09299182","4":"1.104878e+00","5":"0.270319009"},{"1":"factor(monkey)7588","2":"-6.250000e-02","3":"1.81569582","4":"-3.442207e-02","5":"0.972569200"},{"1":"factor(monkey)7598","2":"3.750000e-01","3":"1.94769661","4":"1.925351e-01","5":"0.847485879"},{"1":"factor(monkey)7600","2":"-1.625000e+00","3":"1.94769661","4":"-8.343189e-01","5":"0.404930992"},{"1":"factor(monkey)7623","2":"2.812500e+00","3":"2.09299182","4":"1.343770e+00","5":"0.180291735"},{"1":"factor(monkey)7707","2":"1.312500e+00","3":"2.09299182","4":"6.270928e-01","5":"0.531194536"},{"1":"factor(monkey)7721","2":"1.812500e+00","3":"2.09299182","4":"8.659852e-01","5":"0.387363127"},{"1":"factor(monkey)7828","2":"1.812500e+00","3":"2.09299182","4":"8.659852e-01","5":"0.387363127"},{"1":"factor(monkey)7942","2":"4.375000e+00","3":"1.94769661","4":"2.246243e+00","5":"0.025598621"},{"1":"factor(monkey)7992","2":"5.250000e+00","3":"2.24900632","4":"2.334364e+00","5":"0.020402519"},{"1":"factor(monkey)8053","2":"4.750000e+00","3":"2.24900632","4":"2.112044e+00","5":"0.035716332"},{"1":"factor(monkey)8094","2":"2.750000e+00","3":"2.24900632","4":"1.222762e+00","5":"0.222618881"},{"1":"factor(monkey)8103","2":"2.250000e+00","3":"2.24900632","4":"1.000442e+00","5":"0.318104340"},{"1":"factor(monkey)8179","2":"4.250000e+00","3":"2.24900632","4":"1.889723e+00","5":"0.060000176"},{"1":"factor(monkey)8183","2":"-2.500000e-01","3":"2.24900632","4":"-1.111602e-01","5":"0.911582214"},{"1":"factor(monkey)8338","2":"1.750000e+00","3":"2.24900632","4":"7.781214e-01","5":"0.437263858"},{"1":"factor(monkey)8340","2":"4.750000e+00","3":"2.24900632","4":"2.112044e+00","5":"0.035716332"},{"1":"factor(monkey)8343","2":"4.250000e+00","3":"2.24900632","4":"1.889723e+00","5":"0.060000176"},{"1":"factor(monkey)8371","2":"5.750000e+00","3":"2.24900632","4":"2.556685e+00","5":"0.011184196"},{"1":"factor(monkey)8544","2":"2.750000e+00","3":"2.24900632","4":"1.222762e+00","5":"0.222618881"},{"1":"factor(monkey)8611","2":"3.250000e+00","3":"2.24900632","4":"1.445083e+00","5":"0.149739064"},{"1":"factor(monkey)8729","2":"3.312500e+00","3":"2.09299182","4":"1.582663e+00","5":"0.114815239"},{"1":"factor(monkey)8834","2":"2.187500e+00","3":"2.41366237","4":"9.062991e-01","5":"0.365686559"},{"1":"factor(monkey)8873","2":"6.187500e+00","3":"2.41366237","4":"2.563532e+00","5":"0.010971865"},{"1":"factor(monkey)8956","2":"4.687500e+00","3":"2.41366237","4":"1.942069e+00","5":"0.053298767"},{"1":"factor(monkey)8963","2":"4.187500e+00","3":"2.41366237","4":"1.734915e+00","5":"0.084039563"},{"1":"factor(monkey)9009","2":"2.687500e+00","3":"2.41366237","4":"1.113453e+00","5":"0.266627767"},{"1":"factor(monkey)9014","2":"3.187500e+00","3":"2.41366237","4":"1.320607e+00","5":"0.187890272"},{"1":"factor(monkey)9023","2":"2.187500e+00","3":"2.41366237","4":"9.062991e-01","5":"0.365686559"},{"1":"factor(monkey)9117","2":"1.187500e+00","3":"2.41366237","4":"4.919909e-01","5":"0.623175457"},{"1":"factor(monkey)9344","2":"4.687500e+00","3":"2.41366237","4":"1.942069e+00","5":"0.053298767"},{"1":"factor(monkey)9355","2":"6.187500e+00","3":"2.41366237","4":"2.563532e+00","5":"0.010971865"},{"1":"factor(monkey)9411","2":"3.187500e+00","3":"2.41366237","4":"1.320607e+00","5":"0.187890272"},{"1":"factor(monkey)9416","2":"6.187500e+00","3":"2.41366237","4":"2.563532e+00","5":"0.010971865"},{"1":"factor(monkey)9542","2":"8.125000e-01","3":"1.48757785","4":"5.461899e-01","5":"0.585442774"},{"1":"factor(monkey)9598","2":"7.625000e+00","3":"2.58530938","4":"2.949357e+00","5":"0.003499076"},{"1":"factor(monkey)9609","2":"2.125000e+00","3":"2.58530938","4":"8.219519e-01","5":"0.411920078"},{"1":"factor(monkey)9615","2":"2.625000e+00","3":"2.58530938","4":"1.015352e+00","5":"0.310960381"},{"1":"factor(monkey)9662","2":"4.625000e+00","3":"2.58530938","4":"1.788954e+00","5":"0.074883259"},{"1":"factor(monkey)9680","2":"6.250000e-01","3":"2.58530938","4":"2.417506e-01","5":"0.809179879"},{"1":"factor(monkey)9683","2":"5.125000e+00","3":"2.58530938","4":"1.982355e+00","5":"0.048580117"},{"1":"factor(monkey)9771","2":"6.250000e-01","3":"2.58530938","4":"2.417506e-01","5":"0.809179879"},{"1":"factor(monkey)9847","2":"3.125000e+00","3":"2.58530938","4":"1.208753e+00","5":"0.227947352"},{"1":"factor(monkey)9926","2":"6.625000e+00","3":"2.58530938","4":"2.562556e+00","5":"0.011001901"},{"1":"factor(monkey)9940","2":"3.625000e+00","3":"2.58530938","4":"1.402153e+00","5":"0.162161553"},{"1":"factor(monkey)9986","2":"3.625000e+00","3":"2.58530938","4":"1.402153e+00","5":"0.162161553"},{"1":"factor(monkey)10069","2":"-6.250000e-02","3":"1.81569582","4":"-3.442207e-02","5":"0.972569200"},{"1":"factor(monkey)10084","2":"2.437500e+00","3":"1.81569582","4":"1.342461e+00","5":"0.180715137"},{"1":"factor(monkey)10290","2":"4.625000e+00","3":"2.58530938","4":"1.788954e+00","5":"0.074883259"},{"1":"factor(monkey)10399","2":"-3.750000e-01","3":"1.53243949","4":"-2.447079e-01","5":"0.806891726"},{"1":"factor(monkey)10646","2":"6.062500e+00","3":"2.76264459","4":"2.194455e+00","5":"0.029161550"},{"1":"factor(monkey)10790","2":"6.562500e+00","3":"2.76264459","4":"2.375441e+00","5":"0.018314388"},{"1":"factor(monkey)10826","2":"3.062500e+00","3":"2.76264459","4":"1.108539e+00","5":"0.268738626"},{"1":"factor(monkey)10850","2":"3.562500e+00","3":"2.76264459","4":"1.289525e+00","5":"0.198456854"},{"1":"factor(monkey)10866","2":"2.562500e+00","3":"2.76264459","4":"9.275533e-01","5":"0.354571211"},{"1":"factor(monkey)11252","2":"8.562500e+00","3":"2.76264459","4":"3.099385e+00","5":"0.002170583"},{"1":"factor(monkey)11440","2":"5.500000e+00","3":"2.94464048","4":"1.867800e+00","5":"0.063008689"},{"1":"factor(monkey)11446","2":"8.000000e+00","3":"2.94464048","4":"2.716800e+00","5":"0.007071614"},{"1":"factor(monkey)11475","2":"3.000000e+00","3":"2.94464048","4":"1.018800e+00","5":"0.309323781"},{"1":"factor(monkey)11483","2":"5.500000e+00","3":"2.94464048","4":"1.867800e+00","5":"0.063008689"},{"1":"factor(monkey)11484","2":"6.500000e+00","3":"2.94464048","4":"2.207400e+00","5":"0.028232894"},{"1":"factor(monkey)11542","2":"3.500000e+00","3":"2.94464048","4":"1.188600e+00","5":"0.235771839"},{"1":"factor(monkey)11717","2":"4.000000e+00","3":"2.94464048","4":"1.358400e+00","5":"0.175612222"},{"1":"factor(monkey)11754","2":"4.000000e+00","3":"2.94464048","4":"1.358400e+00","5":"0.175612222"},{"1":"factor(monkey)11781","2":"6.000000e+00","3":"2.94464048","4":"2.037600e+00","5":"0.042686931"},{"1":"factor(monkey)11799","2":"7.000000e+00","3":"2.94464048","4":"2.377200e+00","5":"0.018229337"},{"1":"factor(monkey)11895","2":"2.500000e+00","3":"2.94464048","4":"8.490001e-01","5":"0.396727282"},{"1":"factor(monkey)11916","2":"5.000000e+00","3":"2.94464048","4":"1.698000e+00","5":"0.090803840"},{"1":"factor(monkey)12017","2":"5.500000e+00","3":"2.94464048","4":"1.867800e+00","5":"0.063008689"},{"1":"factor(monkey)12164","2":"5.437500e+00","3":"3.13048431","4":"1.736952e+00","5":"0.083678713"},{"1":"factor(monkey)12298","2":"8.937500e+00","3":"3.13048431","4":"2.854990e+00","5":"0.004680388"},{"1":"factor(monkey)12355","2":"7.937500e+00","3":"3.13048431","4":"2.535550e+00","5":"0.011862943"},{"1":"factor(monkey)12368","2":"3.437500e+00","3":"3.13048431","4":"1.098073e+00","5":"0.273273063"},{"1":"factor(monkey)12381","2":"4.937500e+00","3":"3.13048431","4":"1.577232e+00","5":"0.116059306"},{"1":"factor(monkey)12505","2":"6.437500e+00","3":"3.13048431","4":"2.056391e+00","5":"0.040826302"},{"1":"factor(monkey)12520","2":"4.937500e+00","3":"3.13048431","4":"1.577232e+00","5":"0.116059306"},{"1":"factor(monkey)12532","2":"6.437500e+00","3":"3.13048431","4":"2.056391e+00","5":"0.040826302"},{"1":"factor(monkey)12630","2":"5.437500e+00","3":"3.13048431","4":"1.736952e+00","5":"0.083678713"},{"1":"factor(monkey)12631","2":"7.437500e+00","3":"3.13048431","4":"2.375830e+00","5":"0.018295539"},{"1":"factor(monkey)12749","2":"6.937500e+00","3":"3.13048431","4":"2.216111e+00","5":"0.027622537"},{"1":"factor(monkey)12906","2":"2.437500e+00","3":"3.13048431","4":"7.786335e-01","5":"0.436962634"},{"1":"factor(monkey)12947","2":"5.375000e+00","3":"3.31952984","4":"1.619205e+00","5":"0.106716412"},{"1":"factor(monkey)12958","2":"7.375000e+00","3":"3.31952984","4":"2.221700e+00","5":"0.027236943"},{"1":"factor(monkey)13121","2":"4.875000e+00","3":"3.31952984","4":"1.468581e+00","5":"0.143255789"},{"1":"factor(monkey)13129","2":"5.375000e+00","3":"3.31952984","4":"1.619205e+00","5":"0.106716412"},{"1":"factor(monkey)13131","2":"4.875000e+00","3":"3.31952984","4":"1.468581e+00","5":"0.143255789"},{"1":"factor(monkey)13260","2":"5.875000e+00","3":"3.31952984","4":"1.769829e+00","5":"0.078025353"},{"1":"factor(monkey)13279","2":"5.375000e+00","3":"3.31952984","4":"1.619205e+00","5":"0.106716412"},{"1":"factor(monkey)13312","2":"4.375000e+00","3":"3.31952984","4":"1.317958e+00","5":"0.188774375"},{"1":"factor(monkey)13442","2":"3.375000e+00","3":"3.31952984","4":"1.016710e+00","5":"0.310315126"},{"1":"factor(monkey)13473","2":"6.375000e+00","3":"3.31952984","4":"1.920453e+00","5":"0.055985798"},{"1":"factor(monkey)13578","2":"4.875000e+00","3":"3.31952984","4":"1.468581e+00","5":"0.143255789"},{"1":"factor(monkey)13590","2":"6.875000e+00","3":"3.31952984","4":"2.071076e+00","5":"0.039420756"},{"1":"factor(monkey)13790","2":"5.812500e+00","3":"3.51125999","4":"1.655389e+00","5":"0.099152667"},{"1":"factor(monkey)13825","2":"4.812500e+00","3":"3.51125999","4":"1.370591e+00","5":"0.171783107"},{"1":"factor(monkey)13883","2":"6.312500e+00","3":"3.51125999","4":"1.797788e+00","5":"0.073467506"},{"1":"factor(monkey)13922","2":"7.812500e+00","3":"3.51125999","4":"2.224985e+00","5":"0.027012536"},{"1":"factor(monkey)14043","2":"7.312500e+00","3":"3.51125999","4":"2.082586e+00","5":"0.038348277"},{"1":"factor(monkey)14066","2":"4.812500e+00","3":"3.51125999","4":"1.370591e+00","5":"0.171783107"},{"1":"factor(monkey)14077","2":"6.812500e+00","3":"3.51125999","4":"1.940187e+00","5":"0.053528408"},{"1":"factor(monkey)14137","2":"4.312500e+00","3":"3.51125999","4":"1.228192e+00","5":"0.220578143"},{"1":"factor(monkey)14165","2":"6.312500e+00","3":"3.51125999","4":"1.797788e+00","5":"0.073467506"},{"1":"factor(monkey)14177","2":"4.812500e+00","3":"3.51125999","4":"1.370591e+00","5":"0.171783107"},{"1":"factor(monkey)14307","2":"6.812500e+00","3":"3.51125999","4":"1.940187e+00","5":"0.053528408"},{"1":"factor(monkey)14323","2":"8.312500e+00","3":"3.51125999","4":"2.367384e+00","5":"0.018708484"},{"1":"factor(monkey)14351","2":"7.312500e+00","3":"3.51125999","4":"2.082586e+00","5":"0.038348277"},{"1":"factor(monkey)14651","2":"8.250000e+00","3":"3.70525802","4":"2.226566e+00","5":"0.026905107"},{"1":"factor(monkey)14666","2":"5.250000e+00","3":"3.70525802","4":"1.416905e+00","5":"0.157807347"},{"1":"factor(monkey)14699","2":"8.750000e+00","3":"3.70525802","4":"2.361509e+00","5":"0.019000512"},{"1":"factor(monkey)14823","2":"1.025000e+01","3":"3.70525802","4":"2.766339e+00","5":"0.006110166"},{"1":"factor(monkey)14826","2":"3.750000e+00","3":"3.70525802","4":"1.012075e+00","5":"0.312521306"},{"1":"factor(monkey)14902","2":"7.250000e+00","3":"3.70525802","4":"1.956679e+00","5":"0.051544843"},{"1":"factor(monkey)14919","2":"7.250000e+00","3":"3.70525802","4":"1.956679e+00","5":"0.051544843"},{"1":"factor(monkey)14985","2":"7.750000e+00","3":"3.70525802","4":"2.091622e+00","5":"0.037523810"},{"1":"factor(monkey)15041","2":"7.250000e+00","3":"3.70525802","4":"1.956679e+00","5":"0.051544843"},{"1":"factor(monkey)15088","2":"4.750000e+00","3":"3.70525802","4":"1.281962e+00","5":"0.201092964"},{"1":"factor(monkey)15120","2":"4.750000e+00","3":"3.70525802","4":"1.281962e+00","5":"0.201092964"},{"1":"factor(monkey)15218","2":"5.750000e+00","3":"3.70525802","4":"1.551849e+00","5":"0.122016071"},{"1":"factor(monkey)15530","2":"7.687500e+00","3":"3.90118562","4":"1.970555e+00","5":"0.049924231"},{"1":"factor(monkey)15642","2":"7.187500e+00","3":"3.90118562","4":"1.842389e+00","5":"0.066651841"},{"1":"factor(monkey)15732","2":"6.687500e+00","3":"3.90118562","4":"1.714222e+00","5":"0.087778891"},{"1":"factor(monkey)15820","2":"5.687500e+00","3":"3.90118562","4":"1.457890e+00","5":"0.146178124"},{"1":"factor(monkey)15909","2":"4.687500e+00","3":"3.90118562","4":"1.201558e+00","5":"0.230719242"},{"1":"factor(monkey)15926","2":"7.187500e+00","3":"3.90118562","4":"1.842389e+00","5":"0.066651841"},{"1":"factor(monkey)16002","2":"9.187500e+00","3":"3.90118562","4":"2.355053e+00","5":"0.019326031"},{"1":"factor(monkey)16090","2":"7.687500e+00","3":"3.90118562","4":"1.970555e+00","5":"0.049924231"},{"1":"factor(monkey)16097","2":"5.187500e+00","3":"3.90118562","4":"1.329724e+00","5":"0.184871653"},{"1":"factor(monkey)16169","2":"9.187500e+00","3":"3.90118562","4":"2.355053e+00","5":"0.019326031"},{"1":"factor(monkey)16236","2":"5.187500e+00","3":"3.90118562","4":"1.329724e+00","5":"0.184871653"},{"1":"factor(monkey)16258","2":"6.187500e+00","3":"3.90118562","4":"1.586056e+00","5":"0.114043194"},{"1":"factor(monkey)16447","2":"1.162500e+01","3":"4.09876609","4":"2.836219e+00","5":"0.004954837"},{"1":"factor(monkey)16553","2":"7.625000e+00","3":"4.09876609","4":"1.860316e+00","5":"0.064064047"},{"1":"factor(monkey)16556","2":"8.625000e+00","3":"4.09876609","4":"2.104292e+00","5":"0.036393453"},{"1":"factor(monkey)16598","2":"5.625000e+00","3":"4.09876609","4":"1.372364e+00","5":"0.171231281"},{"1":"factor(monkey)16670","2":"5.625000e+00","3":"4.09876609","4":"1.372364e+00","5":"0.171231281"},{"1":"factor(monkey)16736","2":"9.125000e+00","3":"4.09876609","4":"2.226280e+00","5":"0.026924503"},{"1":"factor(monkey)16807","2":"5.125000e+00","3":"4.09876609","4":"1.250376e+00","5":"0.212379846"},{"1":"factor(monkey)16972","2":"9.125000e+00","3":"4.09876609","4":"2.226280e+00","5":"0.026924503"},{"1":"factor(monkey)17037","2":"8.125000e+00","3":"4.09876609","4":"1.982304e+00","5":"0.048585829"},{"1":"factor(monkey)17047","2":"1.012500e+01","3":"4.09876609","4":"2.470256e+00","5":"0.014197944"},{"1":"factor(monkey)17069","2":"7.625000e+00","3":"4.09876609","4":"1.860316e+00","5":"0.064064047"},{"1":"factor(monkey)17103","2":"7.125000e+00","3":"4.09876609","4":"1.738328e+00","5":"0.083435526"},{"1":"factor(monkey)17285","2":"7.625000e+00","3":"4.09876609","4":"1.860316e+00","5":"0.064064047"},{"1":"factor(monkey)17516","2":"7.062500e+00","3":"4.29777147","4":"1.643294e+00","5":"0.101631615"},{"1":"factor(monkey)17718","2":"5.562500e+00","3":"4.29777147","4":"1.294275e+00","5":"0.196814278"},{"1":"factor(monkey)17738","2":"7.562500e+00","3":"4.29777147","4":"1.759633e+00","5":"0.079744124"},{"1":"factor(monkey)17794","2":"5.062500e+00","3":"4.29777147","4":"1.177936e+00","5":"0.239988783"},{"1":"factor(monkey)17825","2":"7.062500e+00","3":"4.29777147","4":"1.643294e+00","5":"0.101631615"},{"1":"factor(monkey)17927","2":"5.062500e+00","3":"4.29777147","4":"1.177936e+00","5":"0.239988783"},{"1":"factor(monkey)18038","2":"7.562500e+00","3":"4.29777147","4":"1.759633e+00","5":"0.079744124"},{"1":"factor(monkey)18067","2":"5.562500e+00","3":"4.29777147","4":"1.294275e+00","5":"0.196814278"},{"1":"factor(monkey)18069","2":"1.056250e+01","3":"4.29777147","4":"2.457669e+00","5":"0.014692320"},{"1":"factor(monkey)18106","2":"8.562500e+00","3":"4.29777147","4":"1.992312e+00","5":"0.047469830"},{"1":"factor(monkey)18153","2":"9.062500e+00","3":"4.29777147","4":"2.108651e+00","5":"0.036011350"},{"1":"factor(monkey)18230","2":"9.000000e+00","3":"4.49801264","4":"2.000884e+00","5":"0.046531245"},{"1":"factor(monkey)18232","2":"1.000000e+01","3":"4.49801264","4":"2.223204e+00","5":"0.027133995"},{"1":"factor(monkey)18364","2":"1.000000e+01","3":"4.49801264","4":"2.223204e+00","5":"0.027133995"},{"1":"factor(monkey)18407","2":"1.150000e+01","3":"4.49801264","4":"2.556685e+00","5":"0.011184196"},{"1":"factor(monkey)18450","2":"9.000000e+00","3":"4.49801264","4":"2.000884e+00","5":"0.046531245"},{"1":"factor(monkey)18489","2":"5.571141e+00","3":"4.65807995","4":"1.196017e+00","5":"0.232870369"},{"1":"factor(monkey)18520","2":"1.100000e+01","3":"4.49801264","4":"2.445524e+00","5":"0.015183749"},{"1":"factor(monkey)18569","2":"8.500000e+00","3":"4.49801264","4":"1.889723e+00","5":"0.060000176"},{"1":"factor(monkey)18652","2":"1.100000e+01","3":"4.49801264","4":"2.445524e+00","5":"0.015183749"},{"1":"factor(monkey)18653","2":"9.000000e+00","3":"4.49801264","4":"2.000884e+00","5":"0.046531245"},{"1":"factor(monkey)18873","2":"9.000000e+00","3":"4.49801264","4":"2.000884e+00","5":"0.046531245"},{"1":"factor(monkey)18947","2":"1.100000e+01","3":"4.49801264","4":"2.445524e+00","5":"0.015183749"},{"1":"factor(monkey)19178","2":"5.937500e+00","3":"4.69933163","4":"1.263478e+00","5":"0.207643559"},{"1":"factor(monkey)19220","2":"9.937500e+00","3":"4.69933163","4":"2.114662e+00","5":"0.035490064"},{"1":"factor(monkey)19239","2":"8.937500e+00","3":"4.69933163","4":"1.901866e+00","5":"0.058386063"},{"1":"factor(monkey)22020","2":"3.312500e+00","3":"2.09299182","4":"1.582663e+00","5":"0.114815239"},{"1":"factor(monkey)22021","2":"2.812500e+00","3":"2.09299182","4":"1.343770e+00","5":"0.180291735"},{"1":"factor(monkey)22023","2":"6.250000e-02","3":"1.60442379","4":"3.895480e-02","5":"0.968958814"},{"1":"factor(monkey)22024","2":"7.500000e-01","3":"2.24900632","4":"3.334806e-01","5":"0.739062688"},{"1":"factor(monkey)22025","2":"-1.437500e+00","3":"1.60442379","4":"-8.959603e-01","5":"0.371171733"},{"1":"factor(monkey)22047","2":"1.875000e+00","3":"1.94769661","4":"9.626756e-01","5":"0.336679273"},{"1":"factor(monkey)22048","2":"3.750000e-01","3":"1.94769661","4":"1.925351e-01","5":"0.847485879"},{"1":"factor(monkey)22049","2":"2.875000e+00","3":"1.94769661","4":"1.476103e+00","5":"0.141227161"},{"1":"factor(monkey)22050","2":"-1.000000e+00","3":"1.70008898","4":"-5.882045e-01","5":"0.556948129"},{"1":"factor(monkey)22052","2":"1.562500e+00","3":"1.60442379","4":"9.738699e-01","5":"0.331101681"},{"1":"factor(monkey)22053","2":"2.625000e+00","3":"1.53243949","4":"1.712955e+00","5":"0.088012235"},{"1":"factor(monkey)22054","2":"1.875000e+00","3":"1.94769661","4":"9.626756e-01","5":"0.336679273"},{"1":"factor(monkey)22055","2":"3.625000e+00","3":"1.53243949","4":"2.365509e+00","5":"0.018801226"},{"1":"factor(monkey)22056","2":"2.937500e+00","3":"1.81569582","4":"1.617837e+00","5":"0.107011195"},{"1":"factor(monkey)22057","2":"2.000000e+00","3":"1.70008898","4":"1.176409e+00","5":"0.240596983"},{"1":"factor(monkey)22058","2":"2.500000e-01","3":"1.47232024","4":"1.698000e-01","5":"0.865310455"},{"1":"factor(monkey)22060","2":"-1.250000e-01","3":"1.94769661","4":"-6.417837e-02","5":"0.948881619"},{"1":"factor(monkey)22062","2":"2.500000e+00","3":"1.70008898","4":"1.470511e+00","5":"0.142733141"},{"1":"factor(monkey)22064","2":"NA","3":"NA","4":"NA","5":"NA"},{"1":"age:factor(day)2","2":"2.808043e-02","3":"0.02493246","4":"1.126260e+00","5":"0.261180467"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>So the first thing you will notice is that that is <em>a lot</em> of regression coefficients! There are 243 monkeys and 2 days, but only 485 observations. This isn’t enough data to reliably estimate all of these parameters. (Look at the standard errors for the monkey-related coefficients. They are huge!)</p>
<p>So what are we to do?</p>
<p>The problem is the monkeys. If we use <code>monkey</code> as a factor variable, we only have (at most) two observations of each factor level. This is simply not enough observations per to estimate a different intercept for each monkey!</p>
<p>This type of model is often described as having <em>no pooling</em>, which indicates that there is no explicit dependence between the intercepts for each group (<code>monkey</code>). (There is some dependence between groups due to the group-level covariate <code>age</code>.)</p>
</section>
<section id="if-we-ignore-the-monkeys-will-they-go-away-or-another-attempt-at-regression" class="level3">
<h3 class="anchored" data-anchor-id="if-we-ignore-the-monkeys-will-they-go-away-or-another-attempt-at-regression">If we ignore the monkeys, will they go away? or Another attempt at regression</h3>
<p>Our first attempt at a regression model didn’t work particularly well, but that doesn’t mean we should give up<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>. A second option is that we can assume that there is, fundamentally, no difference between monkeys. If all monkeys of the same age have similar amounts of interest in new puzzles, this would be a reasonable assumption. The best case scenario is that not accounting for differences between individual monkeys would still lead to approximately normal residuals, albeit with probably a larger residual variance.</p>
<p>This type of modelling assumption is called <em>complete pooling</em> as it pools the information between groups by treating them all as the same.</p>
<p>Let’s see what happens in this case!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>fit_lm_pool <span class="ot">&lt;-</span> <span class="fu">lm</span>(active_bins <span class="sc">~</span> age<span class="sc">*</span><span class="fu">factor</span>(day), <span class="at">data =</span> activity_2mins)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">summary</span>(fit_lm_pool)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = active_bins ~ age * factor(day), data = activity_2mins)

Residuals:
    Min      1Q  Median      3Q     Max 
-4.5249 -1.5532  0.1415  1.6731  4.1884 

Coefficients:
                 Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)      3.789718   0.344466  11.002   &lt;2e-16 ***
age              0.003126   0.021696   0.144    0.885    
factor(day)2     0.056112   0.488818   0.115    0.909    
age:factor(day)2 0.025170   0.030759   0.818    0.414    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.103 on 481 degrees of freedom
Multiple R-squared:  0.01365,   Adjusted R-squared:  0.0075 
F-statistic: 2.219 on 3 and 481 DF,  p-value: 0.0851</code></pre>
</div>
</div>
<p>On the up side, the regression runs and doesn’t have too many parameters!</p>
<p>The brave and the bold might even try to interpret the coefficients and say something like <em>there doesn’t seem to be a strong effect of age</em>. But there’s real danger in trying to interpret regression coefficients in the presence of a potential confounder (in this case, the monkey ID). And it’s particularly bad form to do this without ever looking at any sort of regression diagnostics. Linear regression is not a magic eight ball.</p>
<p>Let’s look at the diagnostic plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="fu">augment</span>(fit_lm_pool) <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .fitted, <span class="at">y =</span> active_bins <span class="sc">-</span> .fitted)) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">augment</span>(fit_lm_pool) <span class="sc">|&gt;</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> .std.resid)) <span class="sc">+</span> </span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There are certainly some patterns in those residuals (and some suggestion that the error need a heavier tail for this model to make sense).</p>
</section>
</section>
<section id="what-is-between-no-pooling-and-complete-pooling-multilevel-models-thats-what" class="level2">
<h2 class="anchored" data-anchor-id="what-is-between-no-pooling-and-complete-pooling-multilevel-models-thats-what">What is between no pooling and complete pooling? Multilevel models, that’s what</h2>
<p>We are in a Goldilocks situation: no pooling results in a model that has too many independent parameters for the amount of data that we’ve got, while complete pooling has too few parameters to correctly account for the differences between the monkeys. So what is our perfectly tempered porridge<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>?</p>
<p>The answer is to assume that each monkey has its own intercept, but that it’s intercept can only be <em>so far</em> from the overall intercept (that we would’ve gotten from complete pooling). There are a bunch of ways to realize this concept, but the classical method is to use a normal distribution.</p>
<p>In particular, if the <span class="math inline">\(j\)</span>th monkey has observations <span class="math inline">\(y_{ij}\)</span>, <span class="math inline">\(i=1,2\)</span>, then we can write our model as <span class="math display">\[
y_{ij}  \sim N(\mu_j + \beta_\text{age}\, \text{age}_j + \beta_\text{day}\, \text{day}_{ij} + \beta_\text{age,day}\, \text{[age*day]}_{ij}, \sigma^2).
\]</span></p>
<p>The effects of age and day and the data standard deviation (<span class="math inline">\(\sigma\)</span>) are just like they’d be in an ordinary linear regression model. Our modification comes in how we treat the <span class="math inline">\(\mu_j\)</span>.</p>
<p>In a classical linear regression model, we would fit the <span class="math inline">\(\mu_j\)</span>s independently, perhaps with some weakly informative prior distribution. But we’ve already discussed that that won’t work.</p>
<p>Instead we will make the <span class="math inline">\(\mu_j\)</span> <em>exchangeable</em> rather than independent. Exchangeability is a relaxation of the independence assumption to say instead encode that we have no idea which of the intercepts will do what. That is, if we switch around the labels of our intercepts the prior should not change. There is a long and storied history of exchangeable models in statistics, but the short version that is more than sufficient for our purposes is that they usually<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> take the form <span class="math display">\[\begin{align*}
\mu_j \mid \tau \stackrel{\text{iid}}{\sim} &amp;p(\mu_j \mid \tau), \qquad i = 1,\ldots, J \\
\tau \sim &amp; p(\tau).
\end{align*}\]</span></p>
<p>In a regression context, we typically assume that <span class="math display">\[
\mu_j \mid \tau \sim N(\mu, \tau^2)
\]</span> for some <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\tau\)</span> that will need their own priors.</p>
<p>We can explore this difference mathematically. The regression model, which assumes independence of the <span class="math inline">\(\mu_j\)</span>, uses <span class="math display">\[
p(\mu_1, \ldots, \mu_J) = \prod_{j=1}^J N(\mu, \tau_\text{fixed}^2)
\]</span> as the joint prior on <span class="math inline">\(\mu_1,\ldots,\mu_J\)</span>. On the other hand, the exchangeable model, which forms the basis of multilevel models, assumes the joint prior <span class="math display">\[
p(\mu_1, \ldots, \mu_J) = \int_0^\infty \left(\prod_{j=1}^J N(\mu, \tau^2)\right)p(\tau)\,d\tau,
\]</span> for some prior on <span class="math inline">\(p(\tau)\)</span> on <span class="math inline">\(\tau\)</span>.</p>
<p>This might not seem like much of a change, but it can be quite profound. In both cases, the prior is saying that each <span class="math inline">\(\mu_j\)</span> is, with high probability, at most <span class="math inline">\(3\tau\)</span> away from the overall mean <span class="math inline">\(\mu\)</span>. The difference is that while the classical least squares formulation uses a fixed value of <span class="math inline">\(\tau\)</span> that needs to be specified by the modeller, while the exchangeable model lets <span class="math inline">\(\tau\)</span> adapt to the data.</p>
<p>This data adaptation is really nifty! It means that if the groups have similar means, they can borrow information from the other groups (via the narrowing of <span class="math inline">\(\tau\)</span>) in order to improve their precision over an unpooled estimate. On the other hand, if there is a meaningful difference between the groups<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>, this model can still represent that, unlike the unpooled model.</p>
<p>In our context, however, we need a tiny bit more. We have a <em>group-level covariate</em> (specifically <code>age</code>) that we think is going to effect the group mean. So the model we want is <span class="math display">\[\begin{align*}
y_{ij}  \mid \mu_j,\beta, \sigma &amp;\sim N(\mu_j + \beta_\text{day}\, \text{day}_{ij} + \beta_\text{age,day}\, \text{[age*day]}_{ij} , \sigma^2) \\
\mu_j\mid \tau, \mu,\beta &amp;\sim N(\mu +  \beta_\text{age}\, \text{age}_j, \tau^2) \\
\mu &amp;\sim p(\mu)\\
\beta &amp;\sim p(\beta)\\
\tau &amp; \sim p(\tau) \\
\sigma &amp;\sim p(\sigma).
\end{align*}\]</span></p>
<p>In order to fully specify the model we need to set the four prior distributions.</p>
<p>This is an example of a <em>multilevel</em><a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> <em>model</em>. The name comes from the data having multiple levels (in this case two: the observation level and the group level). Both levels have an appropriate model for their mean.</p>
<p>This mathematical representation does a good job in separating out the two different levels. However, there are a lot of other ways of writing multilevel models. An important example is the extended formula notation created<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a> by R’s <code>lme4</code> package. In their notation, we would write this model as</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>formula <span class="ot">&lt;-</span> active_bins_scaled <span class="sc">~</span> age_centred<span class="sc">*</span>day <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> monkey)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first bit of this formula is the same as the formula used in linear regression. The interesting bit is is the <code>(1 | monkey)</code>. This is the way to tell R that the intercept (aka <code>1</code> in formula notation) is going to be grouped by <code>monkey</code> and we are going to put an exchangeable normal prior on it. For more complex models there are more complex variations on this theme, but for the moment we won’t go any further.</p>
</section>
<section id="reasoning-out-some-prior-distributions" class="level2">
<h2 class="anchored" data-anchor-id="reasoning-out-some-prior-distributions">Reasoning out some prior distributions</h2>
<p>We need to set priors. The canny amongst you may have noticed that I did not set priors in the previous two examples. There are two reasons for this: firstly I didn’t feel like it, and secondly none but the most terrible prior distributions would have meaningfully changed the conclusions. This is, it turns out, one of the great truths when it comes to prior distributions: <em>they do not matter until they do</em><a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a>.</p>
<p>In particular, if you have a parameter that <em>directly</em> sees the data (eg it’s in the likelihood) and there is nothing weird going on<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a>, then the prior distribution will usually not do much as any prior will be quickly overwhelmed by the data.</p>
<p>The problem is that we have one parameter in our model (<span class="math inline">\(\tau\)</span>) that does not directly see the data. Instead of directly telling us about an observation, it tells us about how different the <em>groups</em> of observations are. There is usually less information in the data about this type of parameter and, consequently, the prior distribution will be more important. This is especially true when you have more than one grouping variable, or when a variable only has a small number of groups.</p>
<p>So let’s pay some proper attention to the priors.</p>
<p>To begin with, let’s set priors on <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\sigma\)</span> (aka the data-level parameters). This is a <em>considerably</em> easier task if the data is scaled. Otherwise, you need to encode information about the usual scale<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a> of the data into your priors. Sometimes this is a sensible and easy thing to do, but usually it’s easier to simply scale the data. (A lot of software will simply scale your data for you, but it is <em>always</em> better to do it yourself!)</p>
<p>So let’s scale our data. We have three variables that need scaling: <code>age</code> (aka the covariate that isn’t categorical) and <code>active_bins</code> (aka the response). For age, we are going to want to measure it as either <em>years from the youngest monkey</em> or <em>years from the average monkey</em>. I think, in this situation, the first version could make a lot of sense, but we are going with the second. This allows us to interpret <span class="math inline">\(\mu\)</span> as the over-all mean. Otherwise, <span class="math inline">\(\mu\)</span> would tell us about the overall average activity of 4 year old monkeys and we will use <span class="math inline">\(\beta(\text{age}_j - 4)\)</span> to estimate how much the activity changes, on average keeping all other aspects constant, as the monkey ages.</p>
<p>On the other hand, we have no sensible baseline for activity, so deviation from the average seems like a sensible scaling. I also don’t know, <em>a priori</em>, how variable activity is going to be, so I might want to scale<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a> it by its standard deviation. In this case, I’m not going to do that because we have a sensible fixed<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a> upper limit (8), which I can scale by.</p>
<p>One important thing here is that if we scale the data by data-dependent quantities (like the minimum, the mean, or the standard deviation) we <em>must</em> keep track of this information. This is because <em>any</em> future data we try to predict with this model will need to be transformed <em>the same way using the same</em><a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a> <em>numbers</em>! This particularly has implication when you are doing things like test/training set validation or cross validation: in the first case, the test set needs to be scaled in the same way the training set was; while in the second case each cross validation training set needs to be scaled independently and that scaling needs to be used on the corresponding left-out data<a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup>20</sup></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>age_centre <span class="ot">&lt;-</span> <span class="fu">mean</span>(activity_2mins<span class="sc">$</span>age)</span>
<span id="cb9-2"><a href="#cb9-2"></a>age_scale <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">range</span>(activity_2mins<span class="sc">$</span>age))<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>active_bins_centre <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a>activity_2mins_scaled <span class="ot">&lt;-</span> activity_2mins <span class="sc">|&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="fu">mutate</span>(<span class="at">monkey =</span> <span class="fu">factor</span>(monkey),</span>
<span id="cb9-7"><a href="#cb9-7"></a>         <span class="at">day =</span> <span class="fu">factor</span>(day),</span>
<span id="cb9-8"><a href="#cb9-8"></a>         <span class="at">age_centred =</span> (age <span class="sc">-</span> age_centre)<span class="sc">/</span>age_scale,</span>
<span id="cb9-9"><a href="#cb9-9"></a>         <span class="at">active_bins_scaled =</span> (active_bins <span class="sc">-</span> active_bins_centre)<span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="fu">glimpse</span>(activity_2mins_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 485
Columns: 7
$ monkey             &lt;fct&gt; 0, 0, 88, 88, 636, 636, 760, 760, 1257, 1257, 1607,…
$ day                &lt;fct&gt; 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, …
$ total              &lt;dbl&gt; 495, 1003, 2642, 524, 199, 282, 363, 445, 96, 495, …
$ active_bins        &lt;int&gt; 6, 6, 8, 6, 2, 3, 3, 4, 3, 8, 6, 5, 3, 3, 6, 5, 8, …
$ age                &lt;dbl&gt; 29, 29, 29, 29, 28, 28, 30, 30, 27, 27, 27, 27, 27,…
$ age_centred        &lt;dbl&gt; 1.1054718, 1.1054718, 1.1054718, 1.1054718, 1.02854…
$ active_bins_scaled &lt;dbl&gt; 0.50, 0.50, 1.00, 0.50, -0.50, -0.25, -0.25, 0.00, …</code></pre>
</div>
</div>
<p>With our scaling completed, we can now start thinking about prior distributions. The trick with priors is to make them wide enough to cover all plausible values of a parameter without making them so wide that they put a whole bunch of weight on essentially silly values.</p>
<p>We know, for instance, that our unscaled activity will go between 0 and 8. That means that it’s unlikely for the mean of the scaled process to be much bigger than 3 or 4. These considerations, along with the fact that we have centred the data so the mean should be closer to zero, suggest that a <span class="math inline">\(N(0,1)\)</span> prior should be appropriate for <span class="math inline">\(\mu\)</span>.</p>
<p>As we normalised our age data relative to the smallest age, we should think more carefully about the scaling of <span class="math inline">\(\beta\)</span>. Macaques live for 20-30<a href="#fn21" class="footnote-ref" id="fnref21" role="doc-noteref"><sup>21</sup></a> years, so we need to think about, for instance, an ordinary aged macaque that would be 15 years older than the baseline. Thanks to our scaling, the largest change that we can have is around 1, which strongly suggests that if <span class="math inline">\(\beta\)</span> was too much larger than <span class="math inline">\(1/8\)</span> we are going to be in unreasonable territory. So let’s put a <span class="math inline">\(N(0,0.2^2)\)</span> prior<a href="#fn22" class="footnote-ref" id="fnref22" role="doc-noteref"><sup>22</sup></a> on <span class="math inline">\(\beta_\text{age}\)</span> and <span class="math inline">\(\beta_\text{age,day}\)</span>. For <span class="math inline">\(\beta_\text{day}\)</span> we can use a <span class="math inline">\(N(0,1)\)</span> prior.</p>
<p>Similarly, the scaling of <code>activity_bins</code> suggests that a <span class="math inline">\(N(0,1)\)</span> prior would be sufficient for the data-level standard deviation <span class="math inline">\(\sigma\)</span>.</p>
<p>That just leaves us with our choice of prior for the standard deviation of the intercept<a href="#fn23" class="footnote-ref" id="fnref23" role="doc-noteref"><sup>23</sup></a> <span class="math inline">\(\mu_j\)</span>, <span class="math inline">\(\tau\)</span>. Thankfully, we considered this case in detail <a href="https://dansblog.netlify.app/posts/2022-08-29-priors4/priors4.html">in the previous blog post</a>. There I argued that a sensible prior for <span class="math inline">\(\tau\)</span> would be an exponential prior. To be quite honest with you, a half-normal or a half-t also would be fine. But I’m going to stick to my guns. For the scaling, again, it would be a touch surprising (given the scaling of the data) if the group means were more than 3 apart, so choosing <span class="math inline">\(\lambda=1\)</span> in the exponential distribution should give a relatively weak prior without being so wide that we are putting prior mass on a bunch of values that we would never actually want to put prior mass on.</p>
<p>We can then fit the model with <code>brms</code>. In this case, I’m using the <code>cmdstanr</code> back end, because it’s fast and I like it.</p>
<p>To specify the model, we use the <code>lme4</code>-style formula notation discussed above.</p>
<p>To set the priors, we will use <code>brms</code>. Now, if you are Paul you might be able to remember how to set priors in <code>brms</code> without having to look it up, but I am sadly not Paul<a href="#fn24" class="footnote-ref" id="fnref24" role="doc-noteref"><sup>24</sup></a>, so every time I need to set priors in <code>brms</code> I write the formula and use the convenient <code>get_prior</code> function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">library</span>(brms)</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="fu">get_prior</span>(formula, activity_2mins_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["prior"],"name":[1],"type":["chr"],"align":["left"]},{"label":["class"],"name":[2],"type":["chr"],"align":["left"]},{"label":["coef"],"name":[3],"type":["chr"],"align":["left"]},{"label":["group"],"name":[4],"type":["chr"],"align":["left"]},{"label":["resp"],"name":[5],"type":["chr"],"align":["left"]},{"label":["dpar"],"name":[6],"type":["chr"],"align":["left"]},{"label":["nlpar"],"name":[7],"type":["chr"],"align":["left"]},{"label":["lb"],"name":[8],"type":["chr"],"align":["left"]},{"label":["ub"],"name":[9],"type":["chr"],"align":["left"]},{"label":["source"],"name":[10],"type":["chr"],"align":["left"]}],"data":[{"1":"","2":"b","3":"","4":"","5":"","6":"","7":"","8":"","9":"","10":"default"},{"1":"","2":"b","3":"age_centred","4":"","5":"","6":"","7":"","8":"","9":"","10":"default"},{"1":"","2":"b","3":"age_centred:day2","4":"","5":"","6":"","7":"","8":"","9":"","10":"default"},{"1":"","2":"b","3":"day2","4":"","5":"","6":"","7":"","8":"","9":"","10":"default"},{"1":"student_t(3, 0, 2.5)","2":"Intercept","3":"","4":"","5":"","6":"","7":"","8":"","9":"","10":"default"},{"1":"student_t(3, 0, 2.5)","2":"sd","3":"","4":"","5":"","6":"","7":"","8":"0","9":"","10":"default"},{"1":"","2":"sd","3":"","4":"monkey","5":"","6":"","7":"","8":"","9":"","10":"default"},{"1":"","2":"sd","3":"Intercept","4":"monkey","5":"","6":"","7":"","8":"","9":"","10":"default"},{"1":"student_t(3, 0, 2.5)","2":"sigma","3":"","4":"","5":"","6":"","7":"","8":"0","9":"","10":"default"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>From this, we can see that the default prior on <span class="math inline">\(\beta\)</span> is an improper flat prior, the default prior on the intercept is a Student-t with 3 degrees of freedom centred at zero with standard deviation 2.5. The same prior (restricted to positive numbers) is put on all of the standard deviation parameters. These default prior distributions are, to be honest, probably fine in this context<a href="#fn25" class="footnote-ref" id="fnref25" role="doc-noteref"><sup>25</sup></a>, but it is good practice to always set your prior.</p>
<p>We do this as follows. (Note that <code>brms</code> uses Stan, which parameterises the normal distribution by its mean and <em>standard deviation</em>!)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>priors <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="at">coef =</span> <span class="st">"age_centred"</span>) <span class="sc">+</span> </span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="fl">0.2</span>), <span class="at">coef =</span> <span class="st">"age_centred:day2"</span>) <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">coef =</span> <span class="st">"day2"</span>) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>  <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sd) <span class="sc">+</span> <span class="co"># tau</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>)</span>
<span id="cb12-7"><a href="#cb12-7"></a>priors</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["prior"],"name":[1],"type":["chr"],"align":["left"]},{"label":["class"],"name":[2],"type":["chr"],"align":["left"]},{"label":["coef"],"name":[3],"type":["chr"],"align":["left"]},{"label":["group"],"name":[4],"type":["chr"],"align":["left"]},{"label":["resp"],"name":[5],"type":["chr"],"align":["left"]},{"label":["dpar"],"name":[6],"type":["chr"],"align":["left"]},{"label":["nlpar"],"name":[7],"type":["chr"],"align":["left"]},{"label":["lb"],"name":[8],"type":["chr"],"align":["left"]},{"label":["ub"],"name":[9],"type":["chr"],"align":["left"]},{"label":["source"],"name":[10],"type":["chr"],"align":["left"]}],"data":[{"1":"normal(0, 0.2)","2":"b","3":"age_centred","4":"","5":"","6":"","7":"","8":"NA","9":"NA","10":"user"},{"1":"normal(0, 0.2)","2":"b","3":"age_centred:day2","4":"","5":"","6":"","7":"","8":"NA","9":"NA","10":"user"},{"1":"normal(0, 1)","2":"b","3":"day2","4":"","5":"","6":"","7":"","8":"NA","9":"NA","10":"user"},{"1":"normal(0, 1)","2":"sigma","3":"","4":"","5":"","6":"","7":"","8":"NA","9":"NA","10":"user"},{"1":"exponential(1)","2":"sd","3":"","4":"","5":"","6":"","7":"","8":"NA","9":"NA","10":"user"},{"1":"normal(0, 1)","2":"Intercept","3":"","4":"","5":"","6":"","7":"","8":"NA","9":"NA","10":"user"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="pre-experiment-prophylaxis" class="level2">
<h2 class="anchored" data-anchor-id="pre-experiment-prophylaxis">Pre-experiment prophylaxis</h2>
<p>So we have specified some priors using the power of <em>our thoughts</em>. But we should probably check to see if they are broadly sensible. A great thing about Bayesian modelling is that we are explicitly specifying our <em>a priori</em> (or pre-data) assumptions about the data generating process. That means that we can do a fast validation of our priors by simulating from them and checking that they’re not too wild.</p>
<p>There are lots of ways to do this, but the easiest<a href="#fn26" class="footnote-ref" id="fnref26" role="doc-noteref"><sup>26</sup></a> way to do this is to use the <code>sample_prior = "only"</code> option in the <code>brm()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>prior_draws <span class="ot">&lt;-</span> <span class="fu">brm</span>(formula, </span>
<span id="cb13-2"><a href="#cb13-2"></a>           <span class="at">data =</span> activity_2mins_scaled,</span>
<span id="cb13-3"><a href="#cb13-3"></a>           <span class="at">prior =</span> priors,</span>
<span id="cb13-4"><a href="#cb13-4"></a>           <span class="at">sample_prior =</span> <span class="st">"only"</span>,</span>
<span id="cb13-5"><a href="#cb13-5"></a>           <span class="at">backend =</span> <span class="st">"cmdstanr"</span>,</span>
<span id="cb13-6"><a href="#cb13-6"></a>           <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb13-7"><a href="#cb13-7"></a>           <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 0.7 seconds.
Chain 2 finished in 0.7 seconds.
Chain 3 finished in 0.7 seconds.
Chain 4 finished in 0.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.7 seconds.
Total execution time: 0.9 seconds.</code></pre>
</div>
</div>
<p>Now that we have samples from the prior distribution, we can assemble them to work out what our prior tells us we would, pre-data, predict for the number of active bins for a single monkey (in this a single monkey<a href="#fn27" class="footnote-ref" id="fnref27" role="doc-noteref"><sup>27</sup></a> that is 10 years older than the baseline).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>pred_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age_centred =</span> <span class="dv">10</span>, <span class="at">day =</span> <span class="dv">1</span>, <span class="at">monkey =</span> <span class="st">"88"</span>) </span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="fu">tibble</span>(<span class="at">pred =</span> brms<span class="sc">::</span><span class="fu">posterior_predict</span>(prior_draws, </span>
<span id="cb16-3"><a href="#cb16-3"></a>                                      <span class="at">newdata =</span> pred_data )) <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(pred)) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">fill =</span> <span class="st">"lightgrey"</span>) <span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb16-7"><a href="#cb16-7"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">20</span>,<span class="dv">20</span>)) <span class="sc">+</span> </span>
<span id="cb16-9"><a href="#cb16-9"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The vertical lines are (approximately) the minimum and maximum of the data. This<a href="#fn28" class="footnote-ref" id="fnref28" role="doc-noteref"><sup>28</sup></a> suggests that the implied priors are definitely wider than our observed data, but they are not several orders of magnitude too wide. This is a good situation to be in: it gives enough room in the priors that we might be wrong with our specification while also not allowing for truly wild values of the parameters (and implied predictive distribution). One could even go so far as to say that the prior is weakly informative.</p>
<p>Let’s compare this to the default priors on the standard deviation parameters. (The default priors on the regression parameters are improper so we can’t simulate from them. So I replaced the improper prior with a much narrower <span class="math inline">\(N(0,10^2)\)</span> prior. If you make the prior on the <span class="math inline">\(\beta\)</span> wider the prior predictive distribution also gets wider.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>priors_default <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">10</span>), <span class="at">class =</span> <span class="st">"b"</span>)</span>
<span id="cb17-2"><a href="#cb17-2"></a>prior_draws_default <span class="ot">&lt;-</span> <span class="fu">brm</span>(formula, </span>
<span id="cb17-3"><a href="#cb17-3"></a>           <span class="at">data =</span> activity_2mins_scaled,</span>
<span id="cb17-4"><a href="#cb17-4"></a>           <span class="at">prior =</span> priors_default,</span>
<span id="cb17-5"><a href="#cb17-5"></a>           <span class="at">sample_prior =</span> <span class="st">"only"</span>,</span>
<span id="cb17-6"><a href="#cb17-6"></a>           <span class="at">backend =</span> <span class="st">"cmdstanr"</span>,</span>
<span id="cb17-7"><a href="#cb17-7"></a>           <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb17-8"><a href="#cb17-8"></a>           <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 0.6 seconds.
Chain 2 finished in 0.6 seconds.
Chain 3 finished in 0.6 seconds.
Chain 4 finished in 0.6 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.6 seconds.
Total execution time: 0.8 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">tibble</span>(<span class="at">pred =</span> brms<span class="sc">::</span><span class="fu">posterior_predict</span>(prior_draws_default, </span>
<span id="cb19-2"><a href="#cb19-2"></a>                                      <span class="at">newdata =</span> pred_data )) <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(pred)) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), <span class="at">fill =</span> <span class="st">"lightgrey"</span>) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is considerably wider.</p>
</section>
<section id="fitting-the-data-or-do-my-monkeys-get-less-interesting-as-they-age" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-data-or-do-my-monkeys-get-less-interesting-as-they-age">Fitting the data; or do my monkeys get less interesting as they age</h2>
<p>With all of that in hand, we can now fit the data. Hooray. This is done with the same command (minus the <code>sample_prior</code> bit).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>posterior_draws <span class="ot">&lt;-</span> <span class="fu">brm</span>(formula, </span>
<span id="cb20-2"><a href="#cb20-2"></a>           <span class="at">data =</span> activity_2mins_scaled,</span>
<span id="cb20-3"><a href="#cb20-3"></a>           <span class="at">prior =</span> priors,</span>
<span id="cb20-4"><a href="#cb20-4"></a>           <span class="at">backend =</span> <span class="st">"cmdstanr"</span>,</span>
<span id="cb20-5"><a href="#cb20-5"></a>           <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb20-6"><a href="#cb20-6"></a>           <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 1.7 seconds.
Chain 3 finished in 1.8 seconds.
Chain 2 finished in 1.8 seconds.
Chain 4 finished in 1.8 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.8 seconds.
Total execution time: 2.0 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>posterior_draws</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: active_bins_scaled ~ age_centred * day + (1 | monkey) 
   Data: activity_2mins_scaled (Number of observations: 485) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Group-Level Effects: 
~monkey (Number of levels: 243) 
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sd(Intercept)     0.31      0.03     0.25     0.37 1.00     1070     1766

Population-Level Effects: 
                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept           -0.04      0.03    -0.11     0.02 1.00     4222     3171
age_centred          0.02      0.07    -0.11     0.14 1.00     3671     3150
day2                 0.10      0.04     0.03     0.18 1.00     8022     2911
age_centred:day2     0.07      0.07    -0.08     0.22 1.00     6170     2584

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     0.43      0.02     0.39     0.47 1.00     1613     2430

Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>There doesn’t seem to be much of an effect of age in this data.</p>
<p>If you’re curious, this matches well<a href="#fn29" class="footnote-ref" id="fnref29" role="doc-noteref"><sup>29</sup></a> with the output of <code>lme4</code>, which is a nice sense check for simple models. Generally speaking, if they’re the same then they’re both fine. If they are different<a href="#fn30" class="footnote-ref" id="fnref30" role="doc-noteref"><sup>30</sup></a>, then you’ve got to look deeper.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb25-2"><a href="#cb25-2"></a>fit_lme4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(formula, activity_2mins_scaled)</span>
<span id="cb25-3"><a href="#cb25-3"></a>fit_lme4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: active_bins_scaled ~ age_centred * day + (1 | monkey)
   Data: activity_2mins_scaled
REML criterion at convergence: 734.9096
Random effects:
 Groups   Name        Std.Dev.
 monkey   (Intercept) 0.3091  
 Residual             0.4253  
Number of obs: 485, groups:  monkey, 243
Fixed Effects:
     (Intercept)       age_centred              day2  age_centred:day2  
        -0.04114           0.01016           0.10507           0.08507  </code></pre>
</div>
</div>
<p>We can also compare the fit using leave-one-out cross validation. This is similar to AIC, but more directly interpretable. It is the average of <span class="math display">\[
\log p_\text{posterior predictive}(y_{ij} \mid y_{-ij}) = \log \left(\int_\theta p(y_{ij} \mid \theta)p(\theta \mid y_{-ij})\, d\theta\right),
\]</span> where <span class="math inline">\(\theta\)</span> is a vector of all of the parameters in the model. The notation <span class="math inline">\(y_{-ij}\)</span> is the data <em>without</em> the <span class="math inline">\(ij\)</span>th observation. This average is sometimes called the <em>expected log predictive density</em> or elpd.</p>
<p>To compare it with the two linear regression models, I need to fit them in <code>brms</code>. I will use a <span class="math inline">\(N(0,1)\)</span> prior for the monkey intercepts and the same priors as the previous model for the other parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>priors_lm <span class="ot">&lt;-</span>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"b"</span>) <span class="sc">+</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.2</span>), <span class="at">coef =</span> <span class="st">"age_centred"</span>) <span class="sc">+</span> </span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="fl">0.2</span>), <span class="at">coef =</span> <span class="st">"age_centred:day2"</span>) <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">coef =</span> <span class="st">"day2"</span>) <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"Intercept"</span>) <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">class =</span> <span class="st">"sigma"</span>)</span>
<span id="cb27-7"><a href="#cb27-7"></a></span>
<span id="cb27-8"><a href="#cb27-8"></a>posterior_nopool <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb27-9"><a href="#cb27-9"></a>  active_bins_scaled <span class="sc">~</span> age_centred <span class="sc">*</span> day <span class="sc">+</span> monkey, </span>
<span id="cb27-10"><a href="#cb27-10"></a>  <span class="at">data =</span> activity_2mins_scaled,</span>
<span id="cb27-11"><a href="#cb27-11"></a>  <span class="at">prior =</span> priors_lm,</span>
<span id="cb27-12"><a href="#cb27-12"></a>  <span class="at">backend =</span> <span class="st">"cmdstanr"</span>,</span>
<span id="cb27-13"><a href="#cb27-13"></a>  <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb27-14"><a href="#cb27-14"></a>  <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 4.5 seconds.
Chain 3 finished in 4.5 seconds.
Chain 2 finished in 4.5 seconds.
Chain 4 finished in 4.5 seconds.

All 4 chains finished successfully.
Mean chain execution time: 4.5 seconds.
Total execution time: 4.7 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>posterior_pool <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb29-2"><a href="#cb29-2"></a>  active_bins_scaled <span class="sc">~</span> age_centred <span class="sc">*</span> day, </span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="at">data =</span> activity_2mins_scaled,</span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="at">prior =</span> priors_lm,</span>
<span id="cb29-5"><a href="#cb29-5"></a>  <span class="at">backend =</span> <span class="st">"cmdstanr"</span>,</span>
<span id="cb29-6"><a href="#cb29-6"></a>  <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb29-7"><a href="#cb29-7"></a>  <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 0.1 seconds.
Chain 2 finished in 0.1 seconds.
Chain 3 finished in 0.1 seconds.
Chain 4 finished in 0.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.1 seconds.
Total execution time: 0.3 seconds.</code></pre>
</div>
</div>
<p>We an now use the <code>loo_compare</code> function to compare the models. By default, the best model is listed first and the other models are listed below it with the difference in elpd values given. To do this, we need to tell <code>brms</code> to compute the <code>loo</code> criterion using the <code>add_criterion</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>posterior_draws <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(posterior_draws, <span class="st">"loo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 2 observations with a pareto_k &gt; 0.7 in model 'posterior_draws'.
It is recommended to set 'moment_match = TRUE' in order to perform moment
matching for problematic observations.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>posterior_nopool <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(posterior_nopool, <span class="st">"loo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 63 observations with a pareto_k &gt; 0.7 in model
'posterior_nopool'. It is recommended to set 'moment_match = TRUE' in order to
perform moment matching for problematic observations.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>posterior_pool <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(posterior_pool, <span class="st">"loo"</span>)</span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="fu">loo_compare</span>(posterior_draws, posterior_nopool, posterior_pool)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 elpd_diff se_diff
posterior_draws    0.0       0.0  
posterior_pool   -29.0       7.4  
posterior_nopool -53.3       9.0  </code></pre>
</div>
</div>
<p>There are some warnings there suggesting that we could recompute these using a slower method, but for the purposes of today I’m not going to do that and I shall declare that the multilevel model performs <em>far better</em> than the other two models.</p>
</section>
<section id="post-experiment-prophylaxis" class="level2">
<h2 class="anchored" data-anchor-id="post-experiment-prophylaxis">Post-experiment prophylaxis</h2>
<p>Of course, we would be fools to just assume that because we fit a model and compared it to some other models, the model is a good representation of the data. To do that, we need to look at some posterior checks.</p>
<p>The easiest thing to look at is the predictions themselves.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>fitted <span class="ot">&lt;-</span> activity_2mins_scaled <span class="sc">|&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>  <span class="fu">cbind</span>(<span class="fu">t</span>(<span class="fu">posterior_predict</span>(posterior_draws,<span class="at">ndraws =</span> <span class="dv">200</span>))) <span class="sc">|&gt;</span></span>
<span id="cb37-3"><a href="#cb37-3"></a>  <span class="fu">pivot_longer</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">207</span>, <span class="at">names_to =</span> <span class="st">"draw"</span>, <span class="at">values_to =</span> <span class="st">"fitted"</span>)</span>
<span id="cb37-4"><a href="#cb37-4"></a></span>
<span id="cb37-5"><a href="#cb37-5"></a>day_labs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Day 1"</span>, <span class="st">"Day 2"</span>)</span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="fu">names</span>(day_labs) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"2"</span>)</span>
<span id="cb37-7"><a href="#cb37-7"></a></span>
<span id="cb37-8"><a href="#cb37-8"></a>violin_plot <span class="ot">&lt;-</span> fitted <span class="sc">|&gt;</span> </span>
<span id="cb37-9"><a href="#cb37-9"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>( <span class="at">x=</span>age, <span class="at">y =</span> <span class="dv">4</span><span class="sc">*</span>fitted <span class="sc">+</span> active_bins_centre, <span class="at">group =</span> age)) <span class="sc">+</span> </span>
<span id="cb37-10"><a href="#cb37-10"></a>  <span class="fu">geom_violin</span>(<span class="at">colour =</span> <span class="st">"lightgrey"</span>) <span class="sc">+</span></span>
<span id="cb37-11"><a href="#cb37-11"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> active_bins), <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb37-12"><a href="#cb37-12"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>day, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">day =</span> day_labs)) <span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13"></a>  <span class="fu">theme_bw</span>() </span>
<span id="cb37-14"><a href="#cb37-14"></a>violin_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That appears to be a reasonably good fit, although it’s possible that the prediction intervals are a bit wide. We can also look at the plot of the posterior residuals vs the fitted values. Here the fitted values are the mean of the posterior predictive distribution.</p>
<p>Next, let’s check for evidence of non-linearity in <code>age</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>plot_data <span class="ot">&lt;-</span> activity_2mins_scaled <span class="sc">|&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>  <span class="fu">mutate</span>(<span class="at">fitted_mean =</span> <span class="fu">colMeans</span>(<span class="fu">posterior_epred</span>(posterior_draws,<span class="at">ndraws =</span> <span class="dv">200</span>)))</span>
<span id="cb38-3"><a href="#cb38-3"></a></span>
<span id="cb38-4"><a href="#cb38-4"></a>age_plot <span class="ot">&lt;-</span> plot_data <span class="sc">|&gt;</span> </span>
<span id="cb38-5"><a href="#cb38-5"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> active_bins_scaled <span class="sc">-</span> fitted_mean)) <span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb38-7"><a href="#cb38-7"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb38-8"><a href="#cb38-8"></a>age_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There doesn’t seem to be any obvious evidence of non-linearity in the residuals, which suggests the linear model for age was sufficient.</p>
<p>We can also check the distributional assumption<a href="#fn31" class="footnote-ref" id="fnref31" role="doc-noteref"><sup>31</sup></a> that the residuals <span class="math display">\[
r_{ij} = y_{ij} - \mu_j
\]</span> have a Gaussian distribution. We can check this with a qq-plot. Here we are using the posterior mean to define our residuals.</p>
<p>We can look at the qq-plot to see how we’re doing with normality.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>distribution_plot <span class="ot">&lt;-</span> plot_data <span class="sc">|&gt;</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> (active_bins_scaled <span class="sc">-</span> fitted_mean)<span class="sc">/</span><span class="fu">sd</span>(active_bins_scaled <span class="sc">-</span> fitted_mean))) <span class="sc">+</span> </span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb39-3"><a href="#cb39-3"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb39-4"><a href="#cb39-4"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb39-5"><a href="#cb39-5"></a>distribution_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That’s not too bad. A bit of a deviation from normality in the tails but nothing that would make me weep. It could well be an artifact of how I defined and normalised the residuals.</p>
<p>We can also look at the so-called k-hat plot, which can be useful for finding high-leverage observations in general models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>loo_posterior <span class="ot">&lt;-</span> <span class="fu">LOO</span>(posterior_draws) <span class="co">#warnings suppressed</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>loo_posterior</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 485 log-likelihood matrix

         Estimate   SE
elpd_loo   -349.8 12.4
p_loo       117.8  5.2
looic       699.7 24.7
------
Monte Carlo SE of elpd_loo is NA.

Pareto k diagnostic values:
                         Count Pct.    Min. n_eff
(-Inf, 0.5]   (good)     418   86.2%   902       
 (0.5, 0.7]   (ok)        65   13.4%   443       
   (0.7, 1]   (bad)        1    0.2%   272       
   (1, Inf)   (very bad)   1    0.2%   59        
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="fu">plot</span>(loo_posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This suggests that observations 393, 394 are potentially high leverage and we should check them more carefully. I won’t be doing that today.</p>
<p>Finally, let’s look at the residuals vs the fitted values. This is a commonly used diagnostic plot in linear regression and it can be very useful for visually detecting non-linear patterns and heteroskedasticity in the residuals. So let’s make the plot<a href="#fn32" class="footnote-ref" id="fnref32" role="doc-noteref"><sup>32</sup></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>problem_plot <span class="ot">&lt;-</span> plot_data <span class="sc">|&gt;</span> </span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> fitted_mean, <span class="at">y =</span> active_bins_scaled <span class="sc">-</span> fitted_mean)) <span class="sc">+</span> </span>
<span id="cb43-3"><a href="#cb43-3"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb43-4"><a href="#cb43-4"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">colour =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb43-5"><a href="#cb43-5"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>day) <span class="sc">+</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb43-7"><a href="#cb43-7"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb43-8"><a href="#cb43-8"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb43-9"><a href="#cb43-9"></a>problem_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Hmmmm. That’s not <em>excellent</em>. The stripes are related to the 8 distinct values the response can take, but there is definitely a trend in the residuals. In particular, we are under-predicting small values and over-predicting large values. <em>There is something here and we will look into it</em>!</p>
</section>
<section id="understanding-diagnostic-plots-from-multilevel-models" class="level2">
<h2 class="anchored" data-anchor-id="understanding-diagnostic-plots-from-multilevel-models">Understanding diagnostic plots from multilevel models</h2>
<p>The thing is, multilevel models are notorious for having patterns that are essentially a product of the data design and not of any type of statistical misspecification. In a really great paper that you should all read, <a href="https://arxiv.org/pdf/1502.06988.pdf">Adam Loy, Heike Hofmann, and Di Cook</a> talk extensively about the challenges with interpreting diagnostic plots for linear mixed effects models<a href="#fn33" class="footnote-ref" id="fnref33" role="doc-noteref"><sup>33</sup></a>.</p>
<p>I’m not going to fully follow their recommendations, mostly because I’m too lazy<a href="#fn34" class="footnote-ref" id="fnref34" role="doc-noteref"><sup>34</sup></a> to write a for loop, but I am going to appropriate the guts of their idea.</p>
<p>They note that strange patterns can occur in diagnostic plots <em>even for correctly specified models</em>. Moreover, we simply do not know what these patters will be. It’s too complex a function of the design, the structure, the data, and the potential misspecification. That sounds bad, but they note that <em>we don’t need to know what pattern to expect</em>. Why not? Because we can simulate it!</p>
<p>So this is the idea: Let’s simulate some fake<a href="#fn35" class="footnote-ref" id="fnref35" role="doc-noteref"><sup>35</sup></a> data from a correctly specified model that otherwise matches with our data. We can then compare the diagnostic plots from the fake data with diagnostic plots from the real data and see if the patterns are meaningfully different.</p>
<p>In order to do this, we should have a method to construct <em>multiple</em> fake data sets. Why? Well a plot is nothing but another test statistic and we <em>must</em> take this variability into account.</p>
<p>(That said, do what I say, not what I do. This is a blog. I’m not going to code well enough to make this clean and straightforward, so I’m just going to do one.)</p>
<p>There is an entire theory of <a href="https://royalsocietypublishing.org/doi/10.1098/rsta.2009.0120"><em>visual inference</em></a> that uses these lineups of diagnostic plots, where one uses the real data and the rest use realisations of the null data, that is really quite interesting and <em>well</em> beyond the scope of this post. But if you want to know more, read the <a href="https://arxiv.org/pdf/1502.06988.pdf">Low, Hoffman, and Cook</a> paper!</p>
<section id="making-new-data" class="level3">
<h3 class="anchored" data-anchor-id="making-new-data">Making new data</h3>
<p>The first thing that we need to do is to work out how to simulate fake data from a correctly specified model with the same structure. Following the Low etc paper, I’m going to do a simple parameteric bootstrap, where I take the posterior medians of the fitted distribution and simulate data from them.</p>
<p>That said, there are a bunch of other options. Specifically, we have a whole bag of samples from our posterior distribution and it would be possible to use that to select values of<a href="#fn36" class="footnote-ref" id="fnref36" role="doc-noteref"><sup>36</sup></a> <span class="math inline">\((\mu, \beta, \tau, \sigma)\)</span> for our simulation.</p>
<p>So let’s make some fake data and fit the model to it!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>monkey_effect <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">monkey =</span> <span class="fu">unique</span>(activity_2mins_scaled<span class="sc">$</span>monkey), </span>
<span id="cb44-2"><a href="#cb44-2"></a>                        <span class="at">monkey_effect =</span> <span class="fu">rnorm</span>(<span class="dv">243</span>,<span class="dv">0</span>,<span class="fl">0.31</span>))</span>
<span id="cb44-3"><a href="#cb44-3"></a>data_fake <span class="ot">&lt;-</span> activity_2mins_scaled <span class="sc">|&gt;</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>  <span class="fu">left_join</span>(monkey_effect, <span class="at">by =</span> <span class="st">"monkey"</span>)  <span class="sc">|&gt;</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>  <span class="fu">mutate</span>(<span class="at">active_bins_scaled =</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(age_centred),</span>
<span id="cb44-6"><a href="#cb44-6"></a>            <span class="at">mean =</span> <span class="sc">-</span><span class="fl">0.04</span> <span class="sc">+</span><span class="fl">0.01</span> <span class="sc">*</span> age_centred <span class="sc">+</span> </span>
<span id="cb44-7"><a href="#cb44-7"></a>              monkey_effect <span class="sc">+</span> <span class="fu">if_else</span>(day <span class="sc">==</span> <span class="st">"2"</span>, <span class="fl">0.1</span> <span class="sc">+</span> <span class="fl">0.085</span> <span class="sc">*</span>age_centred, <span class="fl">0.0</span>), </span>
<span id="cb44-8"><a href="#cb44-8"></a>            <span class="at">sd =</span> <span class="fl">0.43</span>))</span>
<span id="cb44-9"><a href="#cb44-9"></a>                                              </span>
<span id="cb44-10"><a href="#cb44-10"></a>posterior_draws_fake <span class="ot">&lt;-</span> <span class="fu">brm</span>(formula, </span>
<span id="cb44-11"><a href="#cb44-11"></a>           <span class="at">data =</span> data_fake,</span>
<span id="cb44-12"><a href="#cb44-12"></a>           <span class="at">prior =</span> priors,</span>
<span id="cb44-13"><a href="#cb44-13"></a>           <span class="at">backend =</span> <span class="st">"cmdstanr"</span>,</span>
<span id="cb44-14"><a href="#cb44-14"></a>           <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb44-15"><a href="#cb44-15"></a>           <span class="at">refresh =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 finished in 1.6 seconds.
Chain 2 finished in 1.6 seconds.
Chain 3 finished in 1.6 seconds.
Chain 4 finished in 1.6 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.6 seconds.
Total execution time: 1.8 seconds.</code></pre>
</div>
</div>
</section>
<section id="the-good-plots" class="level3">
<h3 class="anchored" data-anchor-id="the-good-plots">The good plots</h3>
<p>First up, let’s look at the violin plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb46-2"><a href="#cb46-2"></a>fitted_fake <span class="ot">&lt;-</span> data_fake <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3"></a>  <span class="fu">cbind</span>(<span class="fu">t</span>(<span class="fu">posterior_predict</span>(posterior_draws_fake,<span class="at">ndraws =</span> <span class="dv">200</span>))) <span class="sc">|&gt;</span></span>
<span id="cb46-4"><a href="#cb46-4"></a>  <span class="fu">pivot_longer</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">207</span>, <span class="at">names_to =</span> <span class="st">"draw"</span>, <span class="at">values_to =</span> <span class="st">"fitted"</span>)</span>
<span id="cb46-5"><a href="#cb46-5"></a></span>
<span id="cb46-6"><a href="#cb46-6"></a>day_labs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Day 1"</span>, <span class="st">"Day 2"</span>)</span>
<span id="cb46-7"><a href="#cb46-7"></a><span class="fu">names</span>(day_labs) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"2"</span>)</span>
<span id="cb46-8"><a href="#cb46-8"></a></span>
<span id="cb46-9"><a href="#cb46-9"></a>violin_fake <span class="ot">&lt;-</span> fitted_fake <span class="sc">|&gt;</span> </span>
<span id="cb46-10"><a href="#cb46-10"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>( <span class="at">x=</span>age, <span class="at">y =</span> <span class="dv">4</span><span class="sc">*</span>fitted <span class="sc">+</span> active_bins_centre, <span class="at">group =</span> age)) <span class="sc">+</span> </span>
<span id="cb46-11"><a href="#cb46-11"></a>  <span class="fu">geom_violin</span>(<span class="at">colour =</span> <span class="st">"lightgrey"</span>) <span class="sc">+</span></span>
<span id="cb46-12"><a href="#cb46-12"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> active_bins), <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb46-13"><a href="#cb46-13"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>day, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">day =</span> day_labs)) <span class="sc">+</span></span>
<span id="cb46-14"><a href="#cb46-14"></a>  <span class="fu">theme_bw</span>() </span>
<span id="cb46-15"><a href="#cb46-15"></a>  </span>
<span id="cb46-16"><a href="#cb46-16"></a><span class="fu">plot_grid</span>(violin_plot, violin_fake, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Real"</span>, <span class="st">"Fake"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That’s very similar to our data plot.</p>
<p>Next up, we will look at the residuals ordered by age</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>plot_data_fake <span class="ot">&lt;-</span> data_fake <span class="sc">|&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>  <span class="fu">mutate</span>(<span class="at">fitted_mean =</span> <span class="fu">colMeans</span>(<span class="fu">posterior_epred</span>(posterior_draws_fake,<span class="at">ndraws =</span> <span class="dv">200</span>)))</span>
<span id="cb47-3"><a href="#cb47-3"></a></span>
<span id="cb47-4"><a href="#cb47-4"></a>age_fake <span class="ot">&lt;-</span> plot_data_fake <span class="sc">|&gt;</span> </span>
<span id="cb47-5"><a href="#cb47-5"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> active_bins_scaled <span class="sc">-</span> fitted_mean)) <span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb47-7"><a href="#cb47-7"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="fu">plot_grid</span>(age_plot, age_fake, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Real"</span>, <span class="st">"Fake"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Fabulous!</p>
<p>Now let’s check the distributional assumption on the residuals!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>distribution_fake <span class="ot">&lt;-</span> plot_data_fake <span class="sc">|&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">sample =</span> (active_bins_scaled <span class="sc">-</span> fitted_mean)<span class="sc">/</span><span class="fu">sd</span>(active_bins_scaled <span class="sc">-</span> fitted_mean))) <span class="sc">+</span> </span>
<span id="cb48-3"><a href="#cb48-3"></a>  <span class="fu">stat_qq</span>() <span class="sc">+</span></span>
<span id="cb48-4"><a href="#cb48-4"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb48-5"><a href="#cb48-5"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb48-6"><a href="#cb48-6"></a></span>
<span id="cb48-7"><a href="#cb48-7"></a><span class="fu">plot_grid</span>(distribution_plot, distribution_fake, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Real"</span>, <span class="st">"Fake"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Excellent!</p>
<p>Finally, we can look at the k-hat plot. Because I’m lazy, I’m not going to put them side by side. You can scroll.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a>loo_fake <span class="ot">&lt;-</span> <span class="fu">LOO</span>(posterior_draws_fake)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Found 4 observations with a pareto_k &gt; 0.7 in model
'posterior_draws_fake'. It is recommended to set 'moment_match = TRUE' in order
to perform moment matching for problematic observations.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>loo_fake</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 485 log-likelihood matrix

         Estimate   SE
elpd_loo   -372.1 14.9
p_loo       115.4  6.1
looic       744.2 29.7
------
Monte Carlo SE of elpd_loo is NA.

Pareto k diagnostic values:
                         Count Pct.    Min. n_eff
(-Inf, 0.5]   (good)     422   87.0%   579       
 (0.5, 0.7]   (ok)        59   12.2%   220       
   (0.7, 1]   (bad)        4    0.8%   118       
   (1, Inf)   (very bad)   0    0.0%   &lt;NA&gt;      
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a><span class="fu">plot</span>(loo_fake)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And look: we get some extreme values. (Depending on the run we get more or less). This suggests that while it would be useful to look at the data points flagged by the k-hat statistic, it may just be sampling variation.;</p>
<p>All of this suggests our model assumptions are not being grossly violated. All except for that residual vs fitted values plot…</p>
</section>
<section id="the-haunted-residual-vs-fitted-plot" class="level3">
<h3 class="anchored" data-anchor-id="the-haunted-residual-vs-fitted-plot">The haunted residual vs fitted plot</h3>
<p>Now let’s look at our residual vs fitted plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>problem_fake <span class="ot">&lt;-</span> plot_data_fake <span class="sc">|&gt;</span> </span>
<span id="cb54-2"><a href="#cb54-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> fitted_mean, <span class="at">y =</span> active_bins_scaled <span class="sc">-</span> fitted_mean)) <span class="sc">+</span> </span>
<span id="cb54-3"><a href="#cb54-3"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">colour =</span> <span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb54-5"><a href="#cb54-5"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>day) <span class="sc">+</span></span>
<span id="cb54-6"><a href="#cb54-6"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb54-7"><a href="#cb54-7"></a>  <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb54-8"><a href="#cb54-8"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb54-9"><a href="#cb54-9"></a><span class="fu">plot_grid</span>(problem_plot, problem_fake, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Real"</span>, <span class="st">"Fake"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="everybodys-got-something-to-hide-except-me-and-my-monkey_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And what do you know! They look the same. (Well, minus the discretisation artefacts.)</p>
</section>
<section id="so-what-the-hell-is-going-on" class="level3">
<h3 class="anchored" data-anchor-id="so-what-the-hell-is-going-on">So what the hell is going on?</h3>
<p>Great question! It turns out that this is one of those cases where our intuition from linear models <em>does not</em> transfer over to multilevel models.</p>
<p>We can actually reason this out by thinking about a model where we have no covariates.</p>
<p>If we have no pooling then the observations for every monkey are, essentially, averaged to get our estimate of <span class="math inline">\(\mu_j\)</span>. If we repeat this, we will find that our <span class="math inline">\(\mu_j\)</span> are basically<a href="#fn37" class="footnote-ref" id="fnref37" role="doc-noteref"><sup>37</sup></a> unbiased and the corresponding residual <span class="math display">\[
r_{ij} = y_{ij} - \mu_j
\]</span> will have mean zero.</p>
<p>But that’s not what happens when we have partial pooling. When we have partial pooling we are <em>combining</em> our naive average<a href="#fn38" class="footnote-ref" id="fnref38" role="doc-noteref"><sup>38</sup></a> <span class="math inline">\(\bar y_j\)</span> with the global average <span class="math inline">\(\mu\)</span> in a way that accounts for the size of group <span class="math inline">\(j\)</span> relative to other groups as well as the within-group variability relative to the between-group variability.</p>
<details>
<summary>
Expand for maths. Just a little
</summary>
There is, in fact, a formula for it. Just in case you’re a formula sort of person. The posterior estimate for a Gaussian multilevel model with an intercept but no covariates is <span class="math display">\[
\frac{1}{1 +\frac{\sigma^2/n}{\tau^2}}\left(\bar{y}_j + \frac{\sigma^2/n}{\tau^2} \mu\right).
\]</span> When <span class="math inline">\(\sigma/\sqrt{n}\)</span> is small, which happens when the sampling standard deviation of <span class="math inline">\(\bar y_j\)</span> is small relative to the between group variation <span class="math inline">\(\tau\)</span>, this is almost equal to <span class="math inline">\(\bar{y}_j\)</span> and there is almost no pooling. On the other hand, when <span class="math inline">\(\sigma/\sqrt{n}\)</span> is large relative to <span class="math inline">\(\tau\)</span>, then the estimate of <span class="math inline">\(\mu_j\)</span> will be very close to the overall mean <span class="math inline">\(\mu\)</span>.
</details>
<p>The short version is that there is some magical number <span class="math inline">\(\alpha\)</span>, which depends on <span class="math inline">\(\tau\)</span>, <span class="math inline">\(\sigma\)</span>, and <span class="math inline">\(n_j\)</span> such that <span class="math display">\[
\hat \mu_j = \alpha \bar{y}_j + (1-\alpha) \mu.
\]</span> Because of this, the residuals <span class="math display">\[
r_{ij} = y_j - \alpha \bar{y_j} - (1-\alpha)\mu
\]</span> are suddenly <em>not</em> going to have mean zero.</p>
<p>In fact, if we think about it a bit more, we will realise that the model will drag extreme groups to the centre, which accounts for the positive slope in the residuals vs the fitted values.</p>
<p>The slope in this example is quite extreme because the groups are very small (only one or two individuals). But it is a general phenomenon and it’s discussed extensively in Chapter 7 of <a href="http://www.biostat.umn.edu/~hodges/RPLMBook/RPLMBookpage.htm">Jim Hodges’ excellent book</a>. His suggestion is that there isn’t really a good, general way to remove the trend. But that doesn’t mean the plot is useless. It is still able to pinpoint outliers and heteroskedasticity. You’ve just got to tilt your head.</p>
<p>But for the purposes of today we can notice that there don’t seem to be any extreme outliers so everything is probably ok.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>So what have we done? Well we’ve gone through the process of fitting and scruitinising a simple Bayesian multilevel model. We’ve talked about some of the challenges associated with graphical diagnostics for structured data. And we’ve all<a href="#fn39" class="footnote-ref" id="fnref39" role="doc-noteref"><sup>39</sup></a> learnt something about the residual-vs-fitted plot for a multilevel model.</p>
<p>Most importantly, we’ve all learnt the value of using fake data simulated from the posterior model to help us understand our diagnostics.</p>
<p>There is more to the scientific story here. It turns out that while there is no effect over 2 minutes, there is <a href="https://royalsocietypublishing.org/doi/10.1098/rsos.200316">a slight effect over 20 minutes</a>. So the conceptual replication failed, but still found some interesting things.</p>
<p>Of course, I’ve ignored one big elephant in the room: That data was discrete. In the end, our distributional diagnostics didn’t throw up any massive red flags, but nevertheless it could be an interesting exercise to see what happens if we use a more problem-adapted likelihood.</p>
<p>Last, and certainly not least, I barely scratched the surface<a href="#fn40" class="footnote-ref" id="fnref40" role="doc-noteref"><sup>40</sup></a> of the <a href="https://arxiv.org/pdf/1502.06988.pdf">Loy, Hoffman, and Cook</a> paper. Anyone who is interested in fitting Gaussian multilevel models should definitely give it a read.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Mark insisted that I like to his google scholar rather than his website. He’s cute that way.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Mark wants me to tell you that he’s not vain he’s just moving. Sure Jan.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>I know that marmosets suffer from lesbian bed death, but I’m told that a marmoset is not a macaque, which in turn is not a macaw. Ecology is fascinating.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>A real problem in the world is that there aren’t enough monkeys for animal research at the best of times. Once you need aged monkeys, it’s an even smaller population. Non-human primate research is <em>hard</em>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Actually 244, but one of them turned out to be blind. Animal research is a journey.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>It turns out that some of the monkeys didn’t want to give up the puzzle after 20 minutes. One held out for 72 minutes before the data collection ended. Cheeky monkeys.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Did Mark make me do unspeakable, degrading, borderline immoral things to get the data? No.&nbsp;It’s open source. Truly the first time I’ve been disappointed that something was open source.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>If statisticians abandoned linear regression we would have nothing left. We would be desiccated husks propping up the bar at 3am talking about how we used to do loads of lines in the 80s.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Our perfect amount of pool? I don’t know how metaphors work<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>They <em>always</em> take this form if there is a countable collection of exchangeable random variables. For a finite set there are a few more options. But no one talks about those.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>monkeys<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>Also known as a mixed effects or a linear mixed effects model.<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>There are <em>many</em> other ways to represnt Gaussian multilevel models. My former colleague Emi Tanaka and Francis Hui wrote a <a href="https://arxiv.org/abs/1911.08628">great paper</a> on this topic.<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14"><p>Some particularly bold and foolish people take this to mean that priors aren’t important. They usually get their arse handed to them the moment they try to fit an even mildly complex model.<a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15"><p>A non-exhaustive set of weird things: categorical regressors with a rare category, tail parameters, mixture models<a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16"><p>There are situations where this is not true. For instance if you have a log or logit link function you can put reasonable bounds on your coefficients regardless of the scaling of your data. That said, the computational procedures <em>always</em> appreciate a bit of scaling. If there’s one thing that computers hate more that big numbers it’s small numbers.<a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn17"><p>Of course, we know that the there are only 8 fifteen second intervals in two minutes, so we could use this information to make a data-independent scaling. To be brutally francis with you, that’s what you should probably do in this situation, but I’m trying to be pedagogical so let’s at least think about scaling it by the standard deviation.<a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn18"><p>Fixed scaling is always easier than data-dependent scaling<a href="#fnref18" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn19"><p>A real trick for young players is scaling new data by the mean and standard deviation of the new data rather than the old data. That’s a very subtle bug that can be <em>very</em> hard to squash.<a href="#fnref19" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn20"><p>The <code>tidymodels</code> package in R is a great example of an ecosystem that does this properly. <a href="https://www.tmwr.org">Max and Julia’s book</a> on using <code>tidymodels</code> is very excellent and well worth a read.<a href="#fnref20" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn21"><p>Of all of the things in this post, this has been the most aggressively fact checked one<a href="#fnref21" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn22"><p>In prior width and on grindr, you should always expect that he’s rounding up.<a href="#fnref22" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn23"><p>In some places, we would call this a random effect.<a href="#fnref23" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn24"><p>He is very lovely. Many people would prefer that I was him.<a href="#fnref24" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn25"><p>It’s possible the the prior on <span class="math inline">\(\tau\)</span> might be too wide. If we were doing a logistic regression, these priors would definitely be too wide. And if we had a lot of different random terms (eg if we had lots of different species or lots of different labs) then they would also probably be too wide. But they are better than not having priors.<a href="#fnref25" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn26"><p>Not the most computationally efficient, but the easiest. Also because it’s the same code we will later use to fit the model, we are evaluating the priors that are actually used and not the ones that we think we’re using.<a href="#fnref26" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn27"><p> It’s number 88, but because our prior is exchangeable it does not matter which monkey we do this for!<a href="#fnref27" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn28"><p>I also checked different values of <code>age</code> as well as looking at the posterior mean (via <code>posterior_epred</code>) and the conclusions stay the same.<a href="#fnref28" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn29"><p>The numbers will never be exactly equal, but they are of similar orders of magnitude.<a href="#fnref29" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn30"><p>Or if you get some sort of error or warning from <code>lme4</code><a href="#fnref30" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn31"><p>So there’s a wrinkle here. Technically, all of the residuals have different variances, which is annoying. You typically studentise them using the leverage scores, but this is a touch trickier for multilevel models. Chapter 7 of <a href="https://www.google.com/search?client=safari&amp;rls=en&amp;q=richly+parametrized+linear+models&amp;ie=UTF-8&amp;oe=UTF-8">Jim Hodges’s excellent book</a> contains a really good discussion.<a href="#fnref31" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn32"><p>Once again, we are not studentizing the residuals. I’m sorry.<a href="#fnref32" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn33"><p>Another name for a multilevel model with a Gaussian response<a href="#fnref33" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn34"><p>Also because all of my data plots are gonna be stripey as hell, and that kinda destroys the point of visual inference.<a href="#fnref34" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn35"><p>They call it <em>null data</em>.<a href="#fnref35" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn36"><p>Note that I am <em>not</em> using values of <span class="math inline">\(\mu_j\)</span>! I will simulate those from the normal distribution to ensure correct model specification. For the same reason, I am not using a residual bootstrap. The aim here is not to assess uncertainty so much as it is to <a href="#fnref36" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn37"><p>This is a bit more complex when you’re Bayesian, but the intuition still holds. The difference is that now it is asymptotic<a href="#fnref37" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn38"><p>This is the average of all observations in group j. <span class="math display">\[
\bar y_j = \frac{1}{n_j} \sum_{i=1}^{n_j} y_{ij}.
\]</span><a href="#fnref38" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn39"><p>I mean, some of us knew this. Personally, I only remembered after I saw it and swore a bit.<a href="#fnref39" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn40"><p>In particular, they have an interesting discussion on assessing the distributional assumption for <span class="math inline">\(\mu_j\)</span>.<a href="#fnref40" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{simpson2022,
  author = {Simpson, Dan},
  title = {A First Look at Multilevel Regression; or {Everybody’s} Got
    Something to Hide Except Me and My Macaques},
  date = {2022-09-06},
  url = {https://dansblog.netlify.app/2022-09-04-everybodys-got-something-to-hide-except-me-and-my-monkey.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-simpson2022" class="csl-entry quarto-appendix-citeas" role="listitem">
Simpson, Dan. 2022. <span>“A First Look at Multilevel Regression; or
Everybody’s Got Something to Hide Except Me and My Macaques.”</span>
September 6, 2022. <a href="https://dansblog.netlify.app/2022-09-04-everybodys-got-something-to-hide-except-me-and-my-monkey.html">https://dansblog.netlify.app/2022-09-04-everybodys-got-something-to-hide-except-me-and-my-monkey.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/dansblog\.netlify\.app");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>