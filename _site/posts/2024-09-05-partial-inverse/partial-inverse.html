<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dan Simpson">
<meta name="dcterms.date" content="2024-09-05">
<meta name="description" content="Sometimes you just need some elements of the inverse of a sparse matrix. Sometimes you’re working in C++. This is that time.">

<title>Un garçon pas comme les autres (Bayes) - Random C++ Part 2: Sparse partial inverses in Eigen</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Un garçon pas comme les autres (Bayes) - Random C++ Part 2: Sparse partial inverses in Eigen">
<meta property="og:description" content="Sometimes you just need some elements of the inverse of a sparse matrix. Sometimes you’re working in C++. This is that time.">
<meta property="og:image" content="https://dansblog.netlify.app/posts/2024-09-05-partial-inverse/scooby.JPG">
<meta property="og:site_name" content="Un garçon pas comme les autres (Bayes)">
<meta name="twitter:title" content="Sparse Partial inverses in Eigen">
<meta name="twitter:description" content="Sometimes you just need some elements of the inverse of a sparse matrix. Sometimes you’re working in C++. This is that time.">
<meta name="twitter:image" content="https://dansblog.netlify.app/posts/2024-09-05-partial-inverse/scooby.JPG">
<meta name="twitter:creator" content="@dan_p_simpson">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Un garçon pas comme les autres (Bayes)</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About this blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/dan_p_simpson"> <i class="bi bi-twitter" role="img" aria-label="twitter">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dpsimpson"> <i class="bi bi-github" role="img" aria-label="github">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://dansblog.netlify.app"> <i class="bi bi-person-circle" role="img" aria-label="website">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Random C++ Part 2: Sparse partial inverses in Eigen</h1>
                  <div>
        <div class="description">
          Sometimes you just need some elements of the inverse of a sparse matrix. Sometimes you’re working in C++. This is that time.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Stan</div>
                <div class="quarto-category">Sparse matrices</div>
                <div class="quarto-category">Autodiff</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://dansblog.netlify.app">Dan Simpson</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 5, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#a-little-bit-of-motivation" id="toc-a-little-bit-of-motivation" class="nav-link active" data-scroll-target="#a-little-bit-of-motivation">A little bit of motivation</a></li>
  <li><a href="#making-this-work-in-c" id="toc-making-this-work-in-c" class="nav-link" data-scroll-target="#making-this-work-in-c">Making this work in C++</a></li>
  <li><a href="#a-quick-test" id="toc-a-quick-test" class="nav-link" data-scroll-target="#a-quick-test">A quick test</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p><em>The code in this post is indebted (and in some cases wholly ripped off from) work by the glorious <a href="https://www.maths.ed.ac.uk/~flindgre/">Finn Lindgren</a>, who emailed me some code to do this probably a decade ago. Yes I am behind on my emails.</em></p>
<p>The time has come once more to make a blog post truly untethered from context. This time, I’m going to show you how to compute entries of the inverse of a sparse symmetric positive definite matrix that correspond to the non-zero elements of the original matrix. And I am going to once again pull out that rusty spoon that is my C++ skill to do it.</p>
<section id="a-little-bit-of-motivation" class="level2">
<h2 class="anchored" data-anchor-id="a-little-bit-of-motivation">A little bit of motivation</h2>
<p>Computing certain elements of the inverse of a matrix isn’t necessarily the most useless thing possible. It actually comes up quite a lot in statistical applications. For instance, if you are computing the score function while doing maximum likelihood estimation for a multivariate Gaussian you’re gonna need those values. Or, less specifically, if you happen to have a multivariate Gaussian <span class="math inline">\(N(0, Q^{-1})\)</span> parameterized by its precision (inverse covariance) matrix <span class="math inline">\(Q\)</span>, if you are interested in the variance of each coordinate, you need the diagonal of <span class="math inline">\(Q^{-1}\)</span>.</p>
<p>A very real problem with computing <span class="math inline">\(Q^{-1}\)</span> is that it is, infamously, quite expensive. The only really practical way to do it is to solve <span class="math inline">\(n\)</span> linear systems, where <span class="math inline">\(n\)</span> is the number of rows/columns in <span class="math inline">\(Q\)</span>. When <span class="math inline">\(n\)</span> is big, this is going to be a bit of a computational disaster!</p>
<p>Thankfully, there is a convenient set of recursions due to Takahashi, Fagan, and Chen<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> that allow us to compute these elements directly and cheaply from the Cholesky factorization of <span class="math inline">\(Q\)</span>.</p>
<p>In fact, I have <a href="https://dansblog.netlify.app/posts/2022-05-20-to-catch-a-derivative-first-youve-got-to-think-like-a-derivative/to-catch-a-derivative-first-youve-got-to-think-like-a-derivative#primitive-three-the-dreaded-log-determinant">blogged about this before</a>.</p>
<p>Essentially, we need to implement the following pseudocode.</p>
<pre><code> for i = n-1, ..., 0
   for j = n-1, ..., i
   if (L[j,i] not known to be 0)
      Sigma[j,i] = Sigma[i,j] = (I(i==j)/L[i,i] 
        - sum_{k=i+1}^{n-1} L[k,i] Sigma[k,j] ) / L[i,i]</code></pre>
<p>This is not going to be terribly complicated, but it does require a bit of C++ plumbing and dealing with the internal Eigen representation of the Choleksy factor. It’s always so fun to read documentation!</p>
</section>
<section id="making-this-work-in-c" class="level2">
<h2 class="anchored" data-anchor-id="making-this-work-in-c">Making this work in C++</h2>
<p>One of the things about working with a library like Eigen is that we really want to use the official API for its functions as much as possible. Even when we itch to use the undocumented internal structure, we should desist: the API is, usually, pretty stable and it is considerably less likely that an Eigen update will materially break our code if we hold them to the promises they actually make rather than the ones we wish they made.</p>
<p>It might look like you need three iterators to build our algorithm, but we actually need four. Because the matrix is stored in column-major order, we are going to need a new iterator for every distinct column index. In this case, that is 1. A reverse iterator going up column <code>i</code> of <code>Sigma</code> 2. A reverse iterator going up column <code>i</code> of <code>L</code> 3. A reverse iterator going up column <code>j</code> of <code>Sigma</code> 4. A reverse iterator going up column <code>i</code> in sync with iterator 3.</p>
<p>The C++ code is pretty straightforward after that, you just need to keep your iterators in sync.</p>
<p>One wrinkle that I forgot about the first time I coded this is that there are a few things that I need to be true: firstly, I need the output to be the lower-triangle of a symmetric matrix, and secondly I need that matrix to have the same sparsity pattern as <span class="math inline">\(Q\)</span>. To do this, I wrote a RAII helper class, mainly because if I’m going to manipulate raw pointers I’m gonna want some safety.</p>
<p>This helper class is a <em>functor</em>, meaning that its objects are callable with similar syntax to functions. Is this strictly necessary? Of course not. But mummy I love him.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="pp">#include </span><span class="im">&lt;Eigen/SparseCore&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="pp">#include </span><span class="im">&lt;Eigen/SparseCholesky&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="kw">typedef</span> Eigen<span class="op">::</span>SparseMatrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>StorageIndex StorageIndex<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> SpMat<span class="op">&gt;</span> <span class="kw">class</span> MatchPattern <span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="kw">using</span> T <span class="op">=</span> <span class="kw">typename</span> <span class="dt">base_type</span><span class="op">&lt;</span>SpMat<span class="op">&gt;::</span>type<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>    StorageIndex<span class="op">*</span> <span class="va">m_outer</span><span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    StorageIndex<span class="op">*</span> <span class="va">m_inner</span><span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>    T<span class="op">*</span> <span class="va">m_val</span><span class="op">;</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>    StorageIndex <span class="va">m_cols</span><span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>    StorageIndex <span class="va">m_nnz</span><span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a>    <span class="kw">public</span><span class="op">:</span></span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a>    MatchPattern<span class="op">(</span><span class="at">const</span> SpMat<span class="op">&amp;</span> A<span class="op">,</span> <span class="at">const</span> SpMat<span class="op">&amp;</span> pattern<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="co">/**</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co">     *  MatchPattern(const SpMat&amp; A, const SpMat&amp; pattern)</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co">     *  Constructs functor class designed to construct a sparse matrix with</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co">     *  the same non-zero pattern as `pattern` and the same non-zero values </span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="co">     *  as `A`.</span></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="co">     *  </span></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co">     *  This function assumes that the sparsity pattern of `pattern` is a SUBSET</span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co">     *  of the sparsity pattern of `A`. Weird things will happen if this does not</span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co">     *  hold.</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="co">     * </span></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co">     *  Usage:</span></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="co">     *  ```</span></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="co">     *  typedef Eigen::SparseMatrix</span><span class="kw">&lt;double&gt;</span><span class="co"> SpMatrixd;</span></span>
<span id="cb2-30"><a href="#cb2-30"></a><span class="co">     *  SpMatrixd A_pattern = MatchPattern</span><span class="kw">&lt;SpMatrixd&gt;</span><span class="co">(A, pattern)();</span></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="co">     *  ```</span></span>
<span id="cb2-32"><a href="#cb2-32"></a><span class="co">    * */</span></span>
<span id="cb2-33"><a href="#cb2-33"></a>        <span class="va">m_cols</span> <span class="op">=</span> pattern<span class="op">.</span>cols<span class="op">();</span></span>
<span id="cb2-34"><a href="#cb2-34"></a>        <span class="va">m_nnz</span> <span class="op">=</span> pattern<span class="op">.</span>nonZeros<span class="op">();</span></span>
<span id="cb2-35"><a href="#cb2-35"></a></span>
<span id="cb2-36"><a href="#cb2-36"></a>        <span class="va">m_outer</span> <span class="op">=</span> <span class="kw">new</span> StorageIndex<span class="op">[</span><span class="va">m_cols</span> <span class="op">+</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb2-37"><a href="#cb2-37"></a>        <span class="bu">std::</span>copy<span class="op">(</span>pattern<span class="op">.</span>outerIndexPtr<span class="op">(),</span> pattern<span class="op">.</span>outerIndexPtr<span class="op">()</span> <span class="op">+</span> <span class="va">m_cols</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="va">m_outer</span><span class="op">);</span> </span>
<span id="cb2-38"><a href="#cb2-38"></a>        <span class="va">m_inner</span> <span class="op">=</span> <span class="kw">new</span> StorageIndex<span class="op">[</span><span class="va">m_nnz</span><span class="op">];</span></span>
<span id="cb2-39"><a href="#cb2-39"></a>        <span class="bu">std::</span>copy<span class="op">(</span>pattern<span class="op">.</span>innerIndexPtr<span class="op">(),</span> pattern<span class="op">.</span>innerIndexPtr<span class="op">()</span> <span class="op">+</span> <span class="va">m_nnz</span><span class="op">,</span> <span class="va">m_inner</span><span class="op">);</span></span>
<span id="cb2-40"><a href="#cb2-40"></a>        <span class="va">m_val</span> <span class="op">=</span> <span class="kw">new</span> T<span class="op">[</span><span class="va">m_nnz</span><span class="op">];</span></span>
<span id="cb2-41"><a href="#cb2-41"></a></span>
<span id="cb2-42"><a href="#cb2-42"></a></span>
<span id="cb2-43"><a href="#cb2-43"></a>        T<span class="op">*</span> valptr <span class="op">=</span> <span class="va">m_val</span><span class="op">;</span></span>
<span id="cb2-44"><a href="#cb2-44"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="va">m_cols</span><span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>            <span class="kw">typename</span> SpMat<span class="op">::</span>InnerIterator Acol<span class="op">(</span>A<span class="op">,</span> j<span class="op">);</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>            <span class="cf">for</span> <span class="op">(</span><span class="kw">typename</span> SpMat<span class="op">::</span>InnerIterator pattern_col<span class="op">(</span>pattern<span class="op">,</span> j<span class="op">);</span></span>
<span id="cb2-47"><a href="#cb2-47"></a>                pattern_col<span class="op">;</span> <span class="op">++</span>pattern_col<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-48"><a href="#cb2-48"></a>                    <span class="cf">while</span> <span class="op">(</span>Acol <span class="op">&amp;</span> <span class="op">(</span>Acol<span class="op">.</span>row<span class="op">()</span> <span class="op">&lt;</span> pattern_col<span class="op">.</span>row<span class="op">())){</span></span>
<span id="cb2-49"><a href="#cb2-49"></a>                        <span class="op">++</span>Acol<span class="op">;</span></span>
<span id="cb2-50"><a href="#cb2-50"></a>                    <span class="op">}</span></span>
<span id="cb2-51"><a href="#cb2-51"></a>                    valptr<span class="op">++</span> <span class="op">=</span> Acol<span class="op">.</span>value<span class="op">();</span></span>
<span id="cb2-52"><a href="#cb2-52"></a>                    <span class="op">++</span>Acol<span class="op">;</span></span>
<span id="cb2-53"><a href="#cb2-53"></a>                <span class="op">}</span></span>
<span id="cb2-54"><a href="#cb2-54"></a>        <span class="op">}</span></span>
<span id="cb2-55"><a href="#cb2-55"></a>    <span class="op">}</span></span>
<span id="cb2-56"><a href="#cb2-56"></a></span>
<span id="cb2-57"><a href="#cb2-57"></a>    <span class="co">// Specialization for rank-1 matrices A = bc^T</span></span>
<span id="cb2-58"><a href="#cb2-58"></a>    MatchPattern<span class="op">(</span></span>
<span id="cb2-59"><a href="#cb2-59"></a>        <span class="at">const</span> <span class="kw">typename</span> Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span>T<span class="op">,</span><span class="dv">1</span><span class="op">,</span>Eigen<span class="op">::</span>Dynamic<span class="op">&gt;&amp;</span> b<span class="op">,</span> </span>
<span id="cb2-60"><a href="#cb2-60"></a>        <span class="at">const</span> <span class="kw">typename</span> Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span>T<span class="op">,</span><span class="dv">1</span><span class="op">,</span>Eigen<span class="op">::</span>Dynamic<span class="op">&gt;</span> c<span class="op">,</span> </span>
<span id="cb2-61"><a href="#cb2-61"></a>        <span class="at">const</span> SpMat<span class="op">&amp;</span> pattern</span>
<span id="cb2-62"><a href="#cb2-62"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-63"><a href="#cb2-63"></a>    <span class="co">/**</span></span>
<span id="cb2-64"><a href="#cb2-64"></a><span class="co">     *  MatchPattern(typename Eigen::Vector</span><span class="kw">&lt;T&gt;</span><span class="co">&amp; b, typename Eigen::Vector</span><span class="kw">&lt;T&gt;</span><span class="co">&amp; c, const SpMat&amp; pattern)</span></span>
<span id="cb2-65"><a href="#cb2-65"></a><span class="co">     *  A specialization of the MatchPattern class where the matrix to be matched </span></span>
<span id="cb2-66"><a href="#cb2-66"></a><span class="co">     *  is a rank one matrix of the form $A = bc^T$.</span></span>
<span id="cb2-67"><a href="#cb2-67"></a><span class="co">     * </span></span>
<span id="cb2-68"><a href="#cb2-68"></a><span class="co">     *  Usage:</span></span>
<span id="cb2-69"><a href="#cb2-69"></a><span class="co">     *  ```</span></span>
<span id="cb2-70"><a href="#cb2-70"></a><span class="co">     *  typedef Eigen::SparseMatrix</span><span class="kw">&lt;double&gt;</span><span class="co"> SpMatrixd;</span></span>
<span id="cb2-71"><a href="#cb2-71"></a><span class="co">     *  SpMatrixd A_pattern = MatchPattern</span><span class="kw">&lt;SpMatrixd&gt;</span><span class="co">(b, c, pattern)();</span></span>
<span id="cb2-72"><a href="#cb2-72"></a><span class="co">     *  ```</span></span>
<span id="cb2-73"><a href="#cb2-73"></a><span class="co">     * */</span></span>
<span id="cb2-74"><a href="#cb2-74"></a>        <span class="va">m_cols</span> <span class="op">=</span> pattern<span class="op">.</span>cols<span class="op">();</span></span>
<span id="cb2-75"><a href="#cb2-75"></a>        <span class="va">m_nnz</span> <span class="op">=</span> pattern<span class="op">.</span>nonZeros<span class="op">();</span></span>
<span id="cb2-76"><a href="#cb2-76"></a>        <span class="va">m_outer</span> <span class="op">=</span> <span class="kw">new</span> StorageIndex<span class="op">[</span><span class="va">m_cols</span> <span class="op">+</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb2-77"><a href="#cb2-77"></a>        <span class="bu">std::</span>copy<span class="op">(</span>pattern<span class="op">.</span>outerIndexPtr<span class="op">(),</span> pattern<span class="op">.</span>outerIndexPtr<span class="op">()</span> <span class="op">+</span> <span class="va">m_cols</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="va">m_outer</span><span class="op">);</span> </span>
<span id="cb2-78"><a href="#cb2-78"></a>        <span class="va">m_inner</span> <span class="op">=</span> <span class="kw">new</span> StorageIndex<span class="op">[</span><span class="va">m_nnz</span><span class="op">];</span></span>
<span id="cb2-79"><a href="#cb2-79"></a>        <span class="bu">std::</span>copy<span class="op">(</span>pattern<span class="op">.</span>innerIndexPtr<span class="op">(),</span> pattern<span class="op">.</span>innerIndexPtr<span class="op">()</span> <span class="op">+</span> <span class="va">m_nnz</span><span class="op">,</span> <span class="va">m_inner</span><span class="op">);</span></span>
<span id="cb2-80"><a href="#cb2-80"></a>        <span class="va">m_val</span> <span class="op">=</span> <span class="kw">new</span> T<span class="op">[</span><span class="va">m_nnz</span><span class="op">];</span></span>
<span id="cb2-81"><a href="#cb2-81"></a></span>
<span id="cb2-82"><a href="#cb2-82"></a>        T<span class="op">*</span> valptr <span class="op">=</span> <span class="va">m_val</span><span class="op">;</span></span>
<span id="cb2-83"><a href="#cb2-83"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="va">m_cols</span><span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-84"><a href="#cb2-84"></a>            <span class="cf">for</span> <span class="op">(</span><span class="kw">typename</span> SpMat<span class="op">::</span>InnerIterator pattern_col<span class="op">(</span>pattern<span class="op">,</span> j<span class="op">);</span></span>
<span id="cb2-85"><a href="#cb2-85"></a>                pattern_col<span class="op">;</span> <span class="op">++</span>pattern_col<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-86"><a href="#cb2-86"></a>                    valptr<span class="op">++</span> <span class="op">=</span> b<span class="op">.</span>coeff<span class="op">(</span>pattern_col<span class="op">.</span>row<span class="op">())</span> <span class="op">*</span> c<span class="op">.</span>coeff<span class="op">(</span>j<span class="op">);</span></span>
<span id="cb2-87"><a href="#cb2-87"></a>                <span class="op">}</span></span>
<span id="cb2-88"><a href="#cb2-88"></a>        <span class="op">}</span></span>
<span id="cb2-89"><a href="#cb2-89"></a>        </span>
<span id="cb2-90"><a href="#cb2-90"></a>    <span class="op">}</span></span>
<span id="cb2-91"><a href="#cb2-91"></a></span>
<span id="cb2-92"><a href="#cb2-92"></a>    <span class="op">~</span>MatchPattern<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-93"><a href="#cb2-93"></a>        <span class="kw">delete</span><span class="op">[]</span> <span class="va">m_inner</span><span class="op">;</span></span>
<span id="cb2-94"><a href="#cb2-94"></a>        <span class="kw">delete</span><span class="op">[]</span> <span class="va">m_outer</span><span class="op">;</span></span>
<span id="cb2-95"><a href="#cb2-95"></a>        <span class="kw">delete</span><span class="op">[]</span> <span class="va">m_val</span><span class="op">;</span></span>
<span id="cb2-96"><a href="#cb2-96"></a>    <span class="op">}</span></span>
<span id="cb2-97"><a href="#cb2-97"></a></span>
<span id="cb2-98"><a href="#cb2-98"></a>    SpMat <span class="kw">operator</span> <span class="op">()</span> <span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-99"><a href="#cb2-99"></a>        <span class="cf">return</span> <span class="kw">typename</span> SpMat<span class="op">::</span>Map<span class="op">(</span></span>
<span id="cb2-100"><a href="#cb2-100"></a>            <span class="va">m_cols</span><span class="op">,</span></span>
<span id="cb2-101"><a href="#cb2-101"></a>            <span class="va">m_cols</span><span class="op">,</span></span>
<span id="cb2-102"><a href="#cb2-102"></a>            <span class="va">m_nnz</span><span class="op">,</span></span>
<span id="cb2-103"><a href="#cb2-103"></a>            <span class="va">m_outer</span><span class="op">,</span></span>
<span id="cb2-104"><a href="#cb2-104"></a>            <span class="va">m_inner</span><span class="op">,</span></span>
<span id="cb2-105"><a href="#cb2-105"></a>            <span class="va">m_val</span></span>
<span id="cb2-106"><a href="#cb2-106"></a>        <span class="op">);</span></span>
<span id="cb2-107"><a href="#cb2-107"></a>    <span class="op">}</span></span>
<span id="cb2-108"><a href="#cb2-108"></a><span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The first thing to note here is that I am, fundamentally, quite lazy. As such I have made the convenient assumption that the target sparsity pattern is always a subset of the sparsity pattern of interest. This is true for the application that I have in mind, but you should probably be careful if you’re adapting this code to anything else.</p>
<p>The second thing you may have noticed is that there a second constructor that is not needed here at all. This is really a gift to future me and avoids me having to re-write this code at some point in the future. Nothing to see here.</p>
<p>With all of this in hand, we can jump over to the code indebted to<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> Finn.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> SpChol<span class="op">,</span> <span class="kw">typename</span> SpMat<span class="op">&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">typename</span> SpChol<span class="op">::</span>MatrixType partial_inverse<span class="op">(</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="at">const</span> SpChol<span class="op">&amp;</span> llt<span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="at">const</span> SpMat<span class="op">&amp;</span> pattern</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">/**</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"> *  Input:</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co"> *  - `llt`: a Sparse Cholesky factorization of a matrix `Q`.</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co"> *  - `pattern`: a sparse matrix with the target sparsity</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co"> *  Assumptions:</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co"> *  - `pattern` has the same sparsity pattern as `Q` or is a subset of that pattern</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co"> *  Output: </span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co"> *  - A sparse matrix with the same sparsity pattern as `pattern` who's non-zero</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co"> *    elements correspond to the non-zero elements of $Q^{-1}$.</span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co"> **/</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>    <span class="kw">typedef</span> <span class="kw">typename</span> SpMat<span class="op">::</span>ReverseInnerIterator reverse_it<span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>    StorageIndex ncols <span class="op">=</span> llt<span class="op">.</span>cols<span class="op">();</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>    <span class="at">const</span> SpMat<span class="op">&amp;</span> L <span class="op">=</span> llt<span class="op">.</span>matrixL<span class="op">();</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>    SpMat Qinv <span class="op">=</span> L<span class="op">.</span><span class="kw">template</span> selfadjointView<span class="op">&lt;</span>Eigen<span class="op">::</span>Lower<span class="op">&gt;();</span></span>
<span id="cb3-20"><a href="#cb3-20"></a></span>
<span id="cb3-21"><a href="#cb3-21"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> ncols <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">--</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>        reverse_it QinvcolI<span class="op">(</span>Qinv<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>        <span class="cf">for</span> <span class="op">(</span>reverse_it LcolI_slow<span class="op">(</span>L<span class="op">,</span> i<span class="op">);</span> LcolI_slow<span class="op">;</span> <span class="op">--</span>LcolI_slow<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-24"><a href="#cb3-24"></a>            <span class="co">// inner sum iterators</span></span>
<span id="cb3-25"><a href="#cb3-25"></a>            reverse_it LcolI<span class="op">(</span>L<span class="op">,</span> i<span class="op">);</span></span>
<span id="cb3-26"><a href="#cb3-26"></a>            reverse_it QinvcolJ<span class="op">(</span>Qinv<span class="op">,</span> LcolI_slow<span class="op">.</span>row<span class="op">());</span></span>
<span id="cb3-27"><a href="#cb3-27"></a>            </span>
<span id="cb3-28"><a href="#cb3-28"></a>            <span class="co">// Initialize Qinv[j,i]</span></span>
<span id="cb3-29"><a href="#cb3-29"></a>            QinvcolI<span class="op">.</span>valueRef<span class="op">()</span> <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb3-30"><a href="#cb3-30"></a></span>
<span id="cb3-31"><a href="#cb3-31"></a>            <span class="co">// Inner-most sum</span></span>
<span id="cb3-32"><a href="#cb3-32"></a>            <span class="cf">while</span> <span class="op">(</span>LcolI<span class="op">.</span>row<span class="op">()</span> <span class="op">&gt;</span> i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-33"><a href="#cb3-33"></a>                <span class="co">// First up, sync the iterators</span></span>
<span id="cb3-34"><a href="#cb3-34"></a>                <span class="cf">while</span> <span class="op">(</span> QinvcolJ <span class="op">&amp;&amp;</span> <span class="op">(</span>LcolI<span class="op">.</span>row<span class="op">()</span> <span class="op">&lt;</span> QinvcolJ<span class="op">.</span>row<span class="op">())){</span></span>
<span id="cb3-35"><a href="#cb3-35"></a>                    <span class="op">--</span>QinvcolJ<span class="op">;</span></span>
<span id="cb3-36"><a href="#cb3-36"></a>                <span class="op">}</span></span>
<span id="cb3-37"><a href="#cb3-37"></a>                <span class="cf">if</span> <span class="op">(</span>QinvcolJ <span class="op">&amp;&amp;</span> <span class="op">(</span>QinvcolJ<span class="op">.</span>row<span class="op">()</span> <span class="op">==</span> LcolI<span class="op">.</span>row<span class="op">()))</span> <span class="op">{</span></span>
<span id="cb3-38"><a href="#cb3-38"></a>                    QinvcolI<span class="op">.</span>valueRef<span class="op">()</span> <span class="op">-=</span> LcolI<span class="op">.</span>value<span class="op">()</span> <span class="op">*</span> QinvcolJ<span class="op">.</span>value<span class="op">();</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>                    <span class="op">--</span>QinvcolJ<span class="op">;</span></span>
<span id="cb3-40"><a href="#cb3-40"></a>                <span class="op">}</span></span>
<span id="cb3-41"><a href="#cb3-41"></a>                <span class="op">--</span>LcolI<span class="op">;</span></span>
<span id="cb3-42"><a href="#cb3-42"></a>            <span class="op">}</span></span>
<span id="cb3-43"><a href="#cb3-43"></a>            <span class="co">// At this point LcolI is the diagonal value</span></span>
<span id="cb3-44"><a href="#cb3-44"></a>            <span class="cf">if</span> <span class="op">(</span>i <span class="op">==</span> LcolI_slow<span class="op">.</span>row<span class="op">())</span> <span class="op">{</span></span>
<span id="cb3-45"><a href="#cb3-45"></a>                QinvcolI<span class="op">.</span>valueRef<span class="op">()</span> <span class="op">+=</span>  <span class="dv">1</span><span class="op">/</span> LcolI<span class="op">.</span>value<span class="op">();</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>                QinvcolI<span class="op">.</span>valueRef<span class="op">()</span> <span class="op">/=</span>  LcolI<span class="op">.</span>value<span class="op">();</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>            <span class="op">}</span> <span class="cf">else</span><span class="op">{</span></span>
<span id="cb3-48"><a href="#cb3-48"></a>                QinvcolI<span class="op">.</span>valueRef<span class="op">()</span> <span class="op">/=</span>  LcolI<span class="op">.</span>value<span class="op">();</span></span>
<span id="cb3-49"><a href="#cb3-49"></a>                <span class="co">// Set Qinv[i,j] = Qinv[j,i]</span></span>
<span id="cb3-50"><a href="#cb3-50"></a>                <span class="cf">while</span> <span class="op">(</span>QinvcolJ<span class="op">.</span>row<span class="op">()</span> <span class="op">&gt;</span> i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-51"><a href="#cb3-51"></a>                    <span class="op">--</span>QinvcolJ<span class="op">;</span></span>
<span id="cb3-52"><a href="#cb3-52"></a>                <span class="op">}</span></span>
<span id="cb3-53"><a href="#cb3-53"></a>                QinvcolJ<span class="op">.</span>valueRef<span class="op">()</span> <span class="op">=</span> QinvcolI<span class="op">.</span>value<span class="op">();</span></span>
<span id="cb3-54"><a href="#cb3-54"></a>            <span class="op">}</span></span>
<span id="cb3-55"><a href="#cb3-55"></a>            <span class="op">--</span>QinvcolI<span class="op">;</span></span>
<span id="cb3-56"><a href="#cb3-56"></a>        <span class="op">}</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>    <span class="op">}</span></span>
<span id="cb3-58"><a href="#cb3-58"></a></span>
<span id="cb3-59"><a href="#cb3-59"></a>    <span class="co">// Undo the permutation</span></span>
<span id="cb3-60"><a href="#cb3-60"></a>    Qinv <span class="op">=</span> Qinv<span class="op">.</span>twistedBy<span class="op">(</span>llt<span class="op">.</span>permutationP<span class="op">().</span>inverse<span class="op">());</span></span>
<span id="cb3-61"><a href="#cb3-61"></a></span>
<span id="cb3-62"><a href="#cb3-62"></a>    <span class="co">// Return the non-zero elements of Qinv corresponding to the non-zero</span></span>
<span id="cb3-63"><a href="#cb3-63"></a>    <span class="co">// elements of Q</span></span>
<span id="cb3-64"><a href="#cb3-64"></a>    <span class="cf">return</span> MatchPattern<span class="op">(</span>Qinv<span class="op">,</span> Q<span class="op">)();</span></span>
<span id="cb3-65"><a href="#cb3-65"></a></span>
<span id="cb3-66"><a href="#cb3-66"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You’ll probably notice that there are far fewer template shenanigans here than in the block matrix code from yesterday. That is because this only needs to work with scalar types and doesn’t need to be part of the <code>math</code> API. If needed, I guess we could always work out what the derivative of the partial inverse is and implement its reverse-mode specialization in Stan, but frankly why<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> bother.</p>
<p>The other thing you may notice is the line</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1"></a>Qinv <span class="op">=</span> Qinv<span class="op">.</span>twistedBy<span class="op">(</span>llt<span class="op">.</span>permutationP<span class="op">().</span>inverse<span class="op">());</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This exists because the Cholesky factor is not actually performed on <span class="math inline">\(Q\)</span> but rather on a permuted matrix <span class="math inline">\(PQP^T\)</span> for some permutation matrix <span class="math inline">\(P\)</span>. This line basically undoes the permutation and puts everything back into its right place.</p>
</section>
<section id="a-quick-test" class="level2">
<h2 class="anchored" data-anchor-id="a-quick-test">A quick test</h2>
<p>Finally, we need to make sure this works. The easiest way to do this is with a simple example, which is a 25x25 sparse matrix. Everything is hard coded in, because why not.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource cpp number-lines code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="pp">#include </span><span class="im">"partial_inverse.hpp"</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="pp">#include </span><span class="im">"Eigen/SparseCore"</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="pp">#include </span><span class="im">"Eigen/Dense"</span></span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="kw">using</span> SparseMatrix <span class="op">=</span> Eigen<span class="op">::</span>SparseMatrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> Eigen<span class="op">::</span>ColMajor<span class="op">&gt;;</span></span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a>    <span class="dt">int</span> Q_inner<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">8</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">9</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">10</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">11</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>                    <span class="dv">6</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">8</span><span class="op">,</span><span class="dv">12</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">8</span><span class="op">,</span><span class="dv">9</span><span class="op">,</span><span class="dv">13</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">8</span><span class="op">,</span><span class="dv">9</span><span class="op">,</span><span class="dv">14</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">10</span><span class="op">,</span><span class="dv">11</span><span class="op">,</span><span class="dv">15</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">10</span><span class="op">,</span><span class="dv">11</span><span class="op">,</span><span class="dv">12</span><span class="op">,</span><span class="dv">16</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">11</span><span class="op">,</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>                    <span class="dv">12</span><span class="op">,</span><span class="dv">13</span><span class="op">,</span><span class="dv">17</span><span class="op">,</span><span class="dv">8</span><span class="op">,</span><span class="dv">12</span><span class="op">,</span><span class="dv">13</span><span class="op">,</span><span class="dv">14</span><span class="op">,</span><span class="dv">18</span><span class="op">,</span><span class="dv">9</span><span class="op">,</span><span class="dv">13</span><span class="op">,</span><span class="dv">14</span><span class="op">,</span><span class="dv">19</span><span class="op">,</span><span class="dv">10</span><span class="op">,</span><span class="dv">15</span><span class="op">,</span><span class="dv">16</span><span class="op">,</span><span class="dv">20</span><span class="op">,</span><span class="dv">11</span><span class="op">,</span><span class="dv">15</span><span class="op">,</span><span class="dv">16</span><span class="op">,</span><span class="dv">17</span><span class="op">,</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>                    <span class="dv">21</span><span class="op">,</span><span class="dv">12</span><span class="op">,</span><span class="dv">16</span><span class="op">,</span><span class="dv">17</span><span class="op">,</span><span class="dv">18</span><span class="op">,</span><span class="dv">22</span><span class="op">,</span><span class="dv">13</span><span class="op">,</span><span class="dv">17</span><span class="op">,</span><span class="dv">18</span><span class="op">,</span><span class="dv">19</span><span class="op">,</span><span class="dv">23</span><span class="op">,</span><span class="dv">14</span><span class="op">,</span><span class="dv">18</span><span class="op">,</span><span class="dv">19</span><span class="op">,</span><span class="dv">24</span><span class="op">,</span><span class="dv">15</span><span class="op">,</span><span class="dv">20</span><span class="op">,</span><span class="dv">21</span><span class="op">,</span><span class="dv">16</span><span class="op">,</span><span class="dv">20</span><span class="op">,</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>                    <span class="dv">21</span><span class="op">,</span><span class="dv">22</span><span class="op">,</span><span class="dv">17</span><span class="op">,</span><span class="dv">21</span><span class="op">,</span><span class="dv">22</span><span class="op">,</span><span class="dv">23</span><span class="op">,</span><span class="dv">18</span><span class="op">,</span><span class="dv">22</span><span class="op">,</span><span class="dv">23</span><span class="op">,</span><span class="dv">24</span><span class="op">,</span><span class="dv">19</span><span class="op">,</span><span class="dv">23</span><span class="op">,</span><span class="dv">24</span><span class="op">};</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>    <span class="dt">int</span> Q_outer<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">11</span><span class="op">,</span><span class="dv">15</span><span class="op">,</span><span class="dv">18</span><span class="op">,</span><span class="dv">22</span><span class="op">,</span><span class="dv">27</span><span class="op">,</span><span class="dv">32</span><span class="op">,</span><span class="dv">37</span><span class="op">,</span><span class="dv">41</span><span class="op">,</span><span class="dv">45</span><span class="op">,</span><span class="dv">50</span><span class="op">,</span><span class="dv">55</span><span class="op">,</span><span class="dv">60</span><span class="op">,</span><span class="dv">64</span><span class="op">,</span><span class="dv">68</span><span class="op">,</span><span class="dv">73</span><span class="op">,</span><span class="dv">78</span><span class="op">,</span><span class="dv">83</span><span class="op">,</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>                    <span class="dv">87</span><span class="op">,</span><span class="dv">90</span><span class="op">,</span><span class="dv">94</span><span class="op">,</span><span class="dv">98</span><span class="op">,</span><span class="dv">102</span><span class="op">,</span><span class="dv">105</span><span class="op">};</span> </span>
<span id="cb5-17"><a href="#cb5-17"></a>    <span class="dt">double</span> Q_val<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>                    <span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>                    <span class="op">-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>                    <span class="op">-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>                    <span class="op">-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>                    <span class="op">-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>                    <span class="op">-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>                    <span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>                    <span class="op">-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,-</span><span class="fl">1.0</span><span class="op">,</span><span class="fl">5.0</span><span class="op">};</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>    Eigen<span class="op">::</span>VectorXd Qinv_true<span class="op">(</span><span class="dv">105</span><span class="op">);</span></span>
<span id="cb5-27"><a href="#cb5-27"></a>    Qinv_true <span class="op">&lt;&lt;</span> <span class="fl">0.220593295593296</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.233306970806971</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.234139471639472</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.0611402486402486</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.233306970806971</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.220593295593296</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.233306970806971</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.25021645021645</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0611402486402486</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.251621989121989</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0664335664335664</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.25021645021645</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.233306970806971</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.234139471639472</span><span class="op">,</span><span class="fl">0.0611402486402486</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0611402486402486</span><span class="op">,</span><span class="fl">0.251621989121989</span><span class="op">,</span><span class="fl">0.0664335664335664</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0664335664335664</span><span class="op">,</span><span class="fl">0.0664335664335664</span><span class="op">,</span><span class="fl">0.253146853146853</span><span class="op">,</span><span class="fl">0.0664335664335664</span><span class="op">,</span><span class="fl">0.0664335664335664</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0664335664335664</span><span class="op">,</span><span class="fl">0.251621989121989</span><span class="op">,</span><span class="fl">0.0611402486402486</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.0611402486402486</span><span class="op">,</span><span class="fl">0.234139471639472</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.233306970806971</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.25021645021645</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.0664335664335664</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.251621989121989</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0611402486402486</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.0652680652680653</span><span class="op">,</span><span class="fl">0.25021645021645</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.233306970806971</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.220593295593296</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.233306970806971</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.0611402486402486</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.234139471639472</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.0602730602730603</span><span class="op">,</span><span class="fl">0.0547785547785548</span><span class="op">,</span><span class="fl">0.233306970806971</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.051483238983239</span><span class="op">,</span><span class="fl">0.220593295593296</span><span class="op">;</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>    </span>
<span id="cb5-29"><a href="#cb5-29"></a>    <span class="dt">int</span> Q_ncol <span class="op">=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb5-30"><a href="#cb5-30"></a>    <span class="dt">int</span> Q_nnz <span class="op">=</span> <span class="dv">105</span><span class="op">;</span></span>
<span id="cb5-31"><a href="#cb5-31"></a></span>
<span id="cb5-32"><a href="#cb5-32"></a>    SparseMatrix Q <span class="op">=</span> Eigen<span class="op">::</span>Map<span class="op">&lt;</span>SparseMatrix<span class="op">&gt;(</span>Q_ncol<span class="op">,</span> Q_ncol<span class="op">,</span> Q_nnz<span class="op">,</span> Q_outer<span class="op">,</span> Q_inner<span class="op">,</span> Q_val<span class="op">);</span></span>
<span id="cb5-33"><a href="#cb5-33"></a></span>
<span id="cb5-34"><a href="#cb5-34"></a></span>
<span id="cb5-35"><a href="#cb5-35"></a>    <span class="kw">auto</span> llt <span class="op">=</span> Eigen<span class="op">::</span>SimplicialLLT<span class="op">&lt;</span>SparseMatrix<span class="op">&gt;(</span>Q<span class="op">);</span></span>
<span id="cb5-36"><a href="#cb5-36"></a></span>
<span id="cb5-37"><a href="#cb5-37"></a>    SparseMatrix Qinv <span class="op">=</span> partial_inverse<span class="op">(</span>llt<span class="op">,</span> Q<span class="op">);</span></span>
<span id="cb5-38"><a href="#cb5-38"></a>    Eigen<span class="op">::</span>VectorXd Qinv_val <span class="op">=</span> Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>VectorXd<span class="op">&gt;(</span>Qinv<span class="op">.</span>valuePtr<span class="op">(),</span> Q_nnz<span class="op">);</span></span>
<span id="cb5-39"><a href="#cb5-39"></a></span>
<span id="cb5-40"><a href="#cb5-40"></a>    <span class="bu">std::</span>cout <span class="op">&lt;&lt;</span> <span class="st">"The error in the partial inverse is "</span> <span class="op">&lt;&lt;</span> <span class="op">(</span>Qinv_val <span class="op">-</span> Qinv_true<span class="op">).</span>norm<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="st">"!"</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb5-41"><a href="#cb5-41"></a></span>
<span id="cb5-42"><a href="#cb5-42"></a></span>
<span id="cb5-43"><a href="#cb5-43"></a></span>
<span id="cb5-44"><a href="#cb5-44"></a></span>
<span id="cb5-45"><a href="#cb5-45"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output is</p>
<pre><code>The error in the partial inverse is 1.25852e-15!</code></pre>
<p>All good here.</p>
<p>That’s the end for this blog post. Hopefully I’ll be back soon-ish with a more interesting post that actually uses all of this stuff.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Takahashi, K., Fagan, J., Chen, M.S., 1973. Formation of a sparse bus impedance matrix and its application to short circuit study. In: Eighth PICA Conference Proceedings.IEEE Power Engineering Society, pp.&nbsp;63–69 (Papers Presented at the 1973 Power Industry Computer Application Conference in Minneapolis, MN)<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>stolen from<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>One reason would be to use gradient descent on the score function for a Gaussian MLE. Another is that this might be useful inside the <code>generated quantities</code> block to compute things like the marginal variances of the model, but, as the great lady said, not today Satan.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{simpson2024,
  author = {Simpson, Dan},
  title = {Random {C++} {Part} 2: {Sparse} Partial Inverses in {Eigen}},
  date = {2024-09-05},
  url = {https://dansblog.netlify.app/posts/2024-05-08-laplace/laplace.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-simpson2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Simpson, Dan. 2024. <span>“Random C++ Part 2: Sparse Partial Inverses in
Eigen.”</span> September 5, 2024. <a href="https://dansblog.netlify.app/posts/2024-05-08-laplace/laplace.html">https://dansblog.netlify.app/posts/2024-05-08-laplace/laplace.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/dansblog\.netlify\.app");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>